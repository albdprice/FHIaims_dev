!
!  R.Gehrke (2005)

module cluster
  
  use vector_array_class
  use control
  
  implicit none
  
  type (vector_array) :: initial_coords
  real*8, dimension(:), allocatable ::ini_spin_per_atom
  real*8, dimension(:), allocatable ::ini_charge_per_atom
  integer :: n_atoms
  integer :: n_species

  character*20, dimension(:), allocatable :: species_name
  real*8, dimension(:), allocatable :: species_z
  integer, dimension(:), allocatable :: species
  real*8, dimension(:), allocatable :: atomic_energy
  real*8, dimension(:), allocatable :: LJ_epsilon
  real*8, dimension(:), allocatable :: LJ_sigma

  contains

    subroutine cluster_allocate()
      if ((n_atoms .gt. 0) .and. (n_species .gt. 0)) then
         if (.not.allocated(species_name)) then
            allocate(species_name(n_species))
         end if
         if (.not.allocated(species_z)) then
            allocate(species_z(n_species))
         end if
         if (.not.allocated(species)) then
            allocate(species(n_atoms))
         end if
         if (.not.allocated(atomic_energy)) then
            allocate(atomic_energy(n_atoms))
         end if
         if (charged) then
            if (.not.allocated(ini_charge_per_atom)) then
               allocate(ini_charge_per_atom(n_atoms))
            end if
         end if
         if (spin_polarized) then
            if (.not.allocated(ini_spin_per_atom)) then
               allocate(ini_spin_per_atom(n_atoms))
            end if
         end if
         if (potential_flag .eq. 'LJ') then
            if (.not.allocated(LJ_epsilon)) then
               allocate(LJ_epsilon(n_species))
            end if
            if (.not.allocated(LJ_sigma)) then
               allocate(LJ_sigma(n_species))
            end if
         end if
         call allocate_array(initial_coords, n_atoms)
      else
         write (*,*) "No atoms and species found yet."
         write (*,*) "* Aborting."
         stop
      end if

    end subroutine cluster_allocate

    subroutine cluster_deallocate()

      if (allocated(species_name)) then
         deallocate(species_name)
      end if
      if (allocated(species)) then
         deallocate(species)
      end if
      if (allocated(species_z)) then
         deallocate(species_z)
      end if
      if (allocated(atomic_energy)) then
         deallocate(atomic_energy)
      end if
      if (allocated(LJ_epsilon)) then
         deallocate(LJ_epsilon)
      end if
       if (allocated(LJ_sigma)) then
         deallocate(LJ_sigma)
      end if
      if (allocated(ini_charge_per_atom)) then
         deallocate(ini_charge_per_atom)
      end if
      if (allocated(ini_spin_per_atom)) then
         deallocate(ini_spin_per_atom)
      end if

    end subroutine cluster_deallocate

    subroutine write_geometry_file(coords, charge, spin)

      ! imported variables

      ! input
      type (vector_array), intent(in) :: coords
      real*8, dimension(n_atoms), intent(in) :: charge
      real*8, dimension(n_atoms), intent(in) :: spin

      ! counter
      integer :: i_atom

      open (10, FILE = "geometry.in")
      write (10,'(A)') "# geometry-file generated by bh-optimizer"
      do i_atom = 1, n_atoms, 1
         write (10,'(A,3(1X,E20.10),1X,A)') "atom", coords%coords(i_atom)%x, coords%coords(i_atom)%y, &
              coords%coords(i_atom)%z, species_name(species(i_atom)) 
         if (charged) then
            write (10,'(A,1X,E20.10)') "initial_charge", charge(i_atom)
         end if
         if (spin_polarized) then
            write (10,'(A,1X,E20.10)') "initial_moment", spin(i_atom)
         end if
      end do
      close (10)

    end subroutine write_geometry_file

    real*8 function reference_energy()

      ! local variables
      real*8 :: energy

      ! counter
      integer :: i_atom

      energy = 0.d0
      do i_atom = 1, n_atoms, 1
         energy = energy + atomic_energy(species(i_atom))
      end do

      reference_energy = energy / n_atoms

    end function reference_energy
    
end module cluster
