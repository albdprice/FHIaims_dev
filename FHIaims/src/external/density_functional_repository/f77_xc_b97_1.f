c:XC_B97_1subrstart

c    Generated: Mon Nov 19 16:36:44 GMT 2007

      subroutine uks_xc_b97_1
     & (ideriv,npt,rhoa1,rhob1,sigmaaa1,sigmabb1,sigmaab1,
     &  zk,vrhoa,vrhob,vsigmaaa,vsigmabb,vsigmaab,
     &  v2rhoa2,v2rhob2,v2rhoab,
     &  v2rhoasigmaaa,v2rhoasigmaab,v2rhoasigmabb,
     &  v2rhobsigmabb,v2rhobsigmaab,v2rhobsigmaaa,
     &  v2sigmaaa2,v2sigmaaaab,v2sigmaaabb,
     &  v2sigmaab2,v2sigmaabbb,v2sigmabb2)
c
c     F.A. Hamprecht, A.J. Cohen, D.J. Tozer, and N.C. Handy
c     Development and assessment of new exchange-correlation functionals
c     J. Chem. Phys. 109 (1998) 6264-6271
c
c
c     CITATION:
c
c     Functionals were obtained from the Density Functional Repository 
c     as developed and distributed by the Quantum Chemistry Group, 
c     CCLRC Daresbury Laboratory, Daresbury, Cheshire, WA4 4AD 
c     United Kingdom. Contact Huub van Dam (h.j.j.vandam@dl.ac.uk) or 
c     Paul Sherwood for further information.
c
c     COPYRIGHT:
c
c     Users may incorporate the source code into software packages and
c     redistribute the source code provided the source code is not
c     changed in anyway and is properly cited in any documentation or
c     publication related to its use.
c
c     ACKNOWLEDGEMENT:
c
c     The source code was generated using Maple 8 through a modified
c     version of the dfauto script published in:
c
c        R. Strange, F.R. Manby, P.J. Knowles
c        Automatic code generation in density functional theory
c        Comp. Phys. Comm. 136 (2001) 310-318.
c
      implicit real*8 (a-h,o-z)
      integer ideriv,npt
      real*8 rhoa1(npt),rhob1(npt)
      real*8 sigmaaa1(npt),sigmabb1(npt),sigmaab1(npt)
      real*8 zk(npt),vrhoa(npt),vrhob(npt)
      real*8 vsigmaaa(npt),vsigmabb(npt),vsigmaab(npt)
      real*8 v2rhoa2(npt),v2rhob2(npt),v2rhoab(npt)
      real*8 v2rhoasigmaaa(npt),v2rhoasigmaab(npt)
      real*8 v2rhoasigmabb(npt),v2rhobsigmabb(npt)
      real*8 v2rhobsigmaab(npt),v2rhobsigmaaa(npt)
      real*8 v2sigmaaa2(npt),v2sigmaaaab(npt),v2sigmaaabb(npt)
      real*8 v2sigmaab2(npt),v2sigmaabbb(npt),v2sigmabb2(npt)
      parameter(tol=1.0d-20)
      
      if (ideriv.eq.0) then
      
      do i=1,npt
      rhoa = dmax1(0.D0,rhoa1(i))
      rhob = dmax1(0.D0,rhob1(i))
      rho = rhoa+rhob
      if(rho.gt.tol) then
      if(rhoa.lt.tol) then
      rho = rhob
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmabb
      t2 = rhob**(1.D0/3.D0)
      t4 = rhob**2
      t5 = t2**2
      t8 = sigmabb/t5/t4
      t10 = 1.D0+0.4D-2*t8
      t14 = sigmabb**2
      t15 = t4**2
      t19 = t14/t2/t15/rhob
      t20 = t10**2
      t27 = 1/rhob
      t28 = t27**(1.D0/3.D0)
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t43 = dlog(1.D0+0.321646831778707D2/(0.1112037486309468D2*t32
     &+0.3844746237447211D1*t28+0.1644733775567609D1*t35
     &+0.2405871291288192D0*t37))
      t45 = 1.D0+0.2D0*t8
      t49 = t45**2
      zk(i) = -0.9305257363491D0*t2*rhob*(0.789518D0+0.229522D-2*t8
     &/t10+0.105756D-4*t19/t20)-0.3109D-1*rhob*(1.D0
     &+0.1274696188700087D0*t28)*t43*(0.820011D-1+0.543362D0*t8/t45
     &-0.1148412D0*t19/t49)
      elseif(rhob.lt.tol) then
      rho = rhoa
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigma = sigmaaa
      t2 = rhoa**(1.D0/3.D0)
      t4 = rhoa**2
      t5 = t2**2
      t8 = sigmaaa/t5/t4
      t10 = 1.D0+0.4D-2*t8
      t14 = sigmaaa**2
      t15 = t4**2
      t19 = t14/t2/t15/rhoa
      t20 = t10**2
      t27 = 1/rhoa
      t28 = t27**(1.D0/3.D0)
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t43 = dlog(1.D0+0.321646831778707D2/(0.1112037486309468D2*t32
     &+0.3844746237447211D1*t28+0.1644733775567609D1*t35
     &+0.2405871291288192D0*t37))
      t45 = 1.D0+0.2D0*t8
      t49 = t45**2
      zk(i) = -0.9305257363491D0*t2*rhoa*(0.789518D0+0.229522D-2*t8
     &/t10+0.105756D-4*t19/t20)-0.3109D-1*rhoa*(1.D0
     &+0.1274696188700087D0*t28)*t43*(0.820011D-1+0.543362D0*t8/t45
     &-0.1148412D0*t19/t49)
      else ! (.not.(rhoa.lt.tol).and..not.(rhob.lt.tol))
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigmaab = sigmaab1(i)
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmaaa+sigmabb+2.D0*sigmaab
      t4 = rhoa**(1.D0/3.D0)
      t6 = rhoa**2
      t7 = t4**2
      t10 = sigmaaa/t7/t6
      t12 = 1.D0+0.4D-2*t10
      t16 = sigmaaa**2
      t17 = t6**2
      t21 = t16/t4/t17/rhoa
      t22 = t12**2
      t29 = 1/rhoa
      t30 = t29**(1.D0/3.D0)
      t33 = rhoa*(1.D0+0.1274696188700087D0*t30)
      t34 = t29**(1.D0/6.D0)
      t37 = dsqrt(t29)
      t39 = t30**2
      t45 = dlog(1.D0+0.321646831778707D2/(0.1112037486309468D2*t34
     &+0.3844746237447211D1*t30+0.1644733775567609D1*t37
     &+0.2405871291288192D0*t39))
      t47 = 1.D0+0.2D0*t10
      t51 = t47**2
      t59 = rhob**(1.D0/3.D0)
      t61 = rhob**2
      t62 = t59**2
      t65 = sigmabb/t62/t61
      t67 = 1.D0+0.4D-2*t65
      t71 = sigmabb**2
      t72 = t61**2
      t76 = t71/t59/t72/rhob
      t77 = t67**2
      t84 = 1/rhob
      t85 = t84**(1.D0/3.D0)
      t88 = rhob*(1.D0+0.1274696188700087D0*t85)
      t89 = t84**(1.D0/6.D0)
      t92 = dsqrt(t84)
      t94 = t85**2
      t100 = dlog(1.D0+0.321646831778707D2/(0.1112037486309468D2*t89
     &+0.3844746237447211D1*t85+0.1644733775567609D1*t92
     &+0.2405871291288192D0*t94))
      t102 = 1.D0+0.2D0*t65
      t106 = t102**2
      t114 = rhoa+rhob
      t115 = 1/t114
      t116 = t115**(1.D0/3.D0)
      t119 = t115**(1.D0/6.D0)
      t122 = dsqrt(t115)
      t124 = t116**2
      t130 = dlog(1.D0+0.160818243221511D2/(0.598255043577108D1*t119
     &+0.2225569421150687D1*t116+0.8004286349993634D0*t122
     &+0.1897004325747559D0*t124))
      t132 = 0.62182D-1*(1.D0+0.1325688999052018D0*t116)*t130
      t143 = dlog(1.D0+0.2960857464321668D2/(0.8157414703487641D1*t119
     &+0.2247591863577616D1*t116+0.4300972471276643D0*t122
     &+0.1911512595127338D0*t124))
      t146 = rhoa-1.D0*rhob
      t147 = t146*t115
      t148 = 1.D0+t147
      t149 = t148**(1.D0/3.D0)
      t152 = 1.D0-1.D0*t147
      t153 = t152**(1.D0/3.D0)
      t155 = t149*t148+t153*t152-2.D0
      t156 = t146**2
      t157 = t156**2
      t158 = t114**2
      t159 = t158**2
      t161 = t157/t159
      t177 = dlog(1.D0+0.321646831778707D2/(0.1112037486309468D2*t119
     &+0.3844746237447211D1*t116+0.1644733775567609D1*t122
     &+0.2405871291288192D0*t124))
      t193 = 0.5D0*t10+0.5D0*t65
      t196 = 1.D0+0.3D-2*t10+0.3D-2*t65
      t200 = t193**2
      t201 = t196**2
      zk(i) = -0.9305257363491D0*t4*rhoa*(0.789518D0+0.229522D-2*t10
     &/t12+0.105756D-4*t21/t22)-0.3109D-1*t33*t45*(0.820011D-1
     &+0.543362D0*t10/t47-0.1148412D0*t21/t51)-0.9305257363491D0*t59
     &*rhob*(0.789518D0+0.229522D-2*t65/t67+0.105756D-4*t76/t77)
     &-0.3109D-1*t88*t100*(0.820011D-1+0.543362D0*t65/t102-0.1148412D0
     &*t76/t106)+(t114*(-t132+0.3799574853701528D-1*(1.D0
     &+0.6901399211255825D-1*t116)*t143*t155*(1.D0-1.D0*t161)
     &+0.1923661050931536D1*(-0.3109D-1*(1.D0+0.1274696188700087D0
     &*t116)*t177+t132)*t155*t161)+0.3109D-1*t33*t45+0.3109D-1*t88
     &*t100)*(0.955689D0+0.4731312D-2*t193/t196-0.19723284D-3*t200/t201)
      endif ! rhoa,rhob
      else ! rho
      zk(i) = 0.0d0
      endif ! rho
      enddo
      
      else if(ideriv.eq.1) then
      
      do i=1,npt
      rhoa = dmax1(0.D0,rhoa1(i))
      rhob = dmax1(0.D0,rhob1(i))
      rho = rhoa+rhob
      if(rho.gt.tol) then
      if(rhoa.lt.tol) then
      rho = rhob
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmabb
      t2 = rhob**(1.D0/3.D0)
      t3 = t2*rhob
      t4 = rhob**2
      t5 = t2**2
      t7 = 1/t5/t4
      t8 = sigmabb*t7
      t10 = 1.D0+0.4D-2*t8
      t11 = 1/t10
      t14 = sigmabb**2
      t15 = t4**2
      t18 = 1/t2/t15/rhob
      t19 = t14*t18
      t20 = t10**2
      t21 = 1/t20
      t24 = 0.789518D0+0.229522D-2*t8*t11+0.105756D-4*t19*t21
      t27 = 1/rhob
      t28 = t27**(1.D0/3.D0)
      t30 = 1.D0+0.1274696188700087D0*t28
      t31 = rhob*t30
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t39 = 0.1112037486309468D2*t32+0.3844746237447211D1*t28
     &+0.1644733775567609D1*t35+0.2405871291288192D0*t37
      t42 = 1.D0+0.321646831778707D2/t39
      t43 = dlog(t42)
      t45 = 1.D0+0.2D0*t8
      t46 = 1/t45
      t49 = t45**2
      t50 = 1/t49
      t53 = 0.820011D-1+0.543362D0*t8*t46-0.1148412D0*t19*t50
      t54 = t43*t53
      zk(i) = -0.9305257363491D0*t3*t24-0.3109D-1*t31*t54
      vrhoa(i) = 0.D0
      t62 = sigmabb/t5/t4/rhob
      t68 = t14/t2/t15/t4
      t72 = t15**2
      t75 = t14*sigmabb/t72/rhob
      t77 = 1/t20/t10
      t86 = 1/t37
      t90 = t39**2
      t93 = t32**2
      t94 = t93**2
      t97 = 1/t4
      t119 = 1/t49/t45
      vrhob(i) = -0.12407009817988D1*t2*t24-0.9305257363491D0*t3*(
     &-0.6120586666666667D-2*t62*t11-0.3192085333333333D-4*t68*t21
     &+0.2256128D-6*t75*t77)-0.3109D-1*t30*t43*t53
     &+0.1321010150222857D-2*t27*t86*t54+0.1D1*t31/t90*(
     &-0.1853395810515781D1/t94/t32*t97-0.128158207914907D1*t86*t97
     &-0.8223668877838045D0/t35*t97-0.1603914194192128D0/t28*t97)/t42
     &*t53-0.3109D-1*t31*t43*(-0.1448965333333333D1*t62*t46
     &+0.9022794666666667D0*t68*t50-0.12249728D0*t75*t119)
      vsigmaaa(i) = 0.D0
      vsigmaab(i) = 0.D0
      t128 = sigmabb*t18
      t132 = t14/t72
      vsigmabb(i) = -0.9305257363491D0*t3*(0.229522D-2*t7*t11
     &+0.1197032D-4*t128*t21-0.846048D-7*t132*t77)-0.3109D-1*t31*t43*
     &(0.543362D0*t7*t46-0.3383548D0*t128*t50+0.4593648D-1*t132*t119)
      elseif(rhob.lt.tol) then
      rho = rhoa
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigma = sigmaaa
      t2 = rhoa**(1.D0/3.D0)
      t3 = t2*rhoa
      t4 = rhoa**2
      t5 = t2**2
      t7 = 1/t5/t4
      t8 = sigmaaa*t7
      t10 = 1.D0+0.4D-2*t8
      t11 = 1/t10
      t14 = sigmaaa**2
      t15 = t4**2
      t18 = 1/t2/t15/rhoa
      t19 = t14*t18
      t20 = t10**2
      t21 = 1/t20
      t24 = 0.789518D0+0.229522D-2*t8*t11+0.105756D-4*t19*t21
      t27 = 1/rhoa
      t28 = t27**(1.D0/3.D0)
      t30 = 1.D0+0.1274696188700087D0*t28
      t31 = rhoa*t30
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t39 = 0.1112037486309468D2*t32+0.3844746237447211D1*t28
     &+0.1644733775567609D1*t35+0.2405871291288192D0*t37
      t42 = 1.D0+0.321646831778707D2/t39
      t43 = dlog(t42)
      t45 = 1.D0+0.2D0*t8
      t46 = 1/t45
      t49 = t45**2
      t50 = 1/t49
      t53 = 0.820011D-1+0.543362D0*t8*t46-0.1148412D0*t19*t50
      t54 = t43*t53
      zk(i) = -0.9305257363491D0*t3*t24-0.3109D-1*t31*t54
      t62 = sigmaaa/t5/t4/rhoa
      t68 = t14/t2/t15/t4
      t72 = t15**2
      t75 = t14*sigmaaa/t72/rhoa
      t77 = 1/t20/t10
      t86 = 1/t37
      t90 = t39**2
      t93 = t32**2
      t94 = t93**2
      t97 = 1/t4
      t119 = 1/t49/t45
      vrhoa(i) = -0.12407009817988D1*t2*t24-0.9305257363491D0*t3*(
     &-0.6120586666666667D-2*t62*t11-0.3192085333333333D-4*t68*t21
     &+0.2256128D-6*t75*t77)-0.3109D-1*t30*t43*t53
     &+0.1321010150222857D-2*t27*t86*t54+0.1D1*t31/t90*(
     &-0.1853395810515781D1/t94/t32*t97-0.128158207914907D1*t86*t97
     &-0.8223668877838045D0/t35*t97-0.1603914194192128D0/t28*t97)/t42
     &*t53-0.3109D-1*t31*t43*(-0.1448965333333333D1*t62*t46
     &+0.9022794666666667D0*t68*t50-0.12249728D0*t75*t119)
      vrhob(i) = 0.D0
      t128 = sigmaaa*t18
      t132 = t14/t72
      vsigmaaa(i) = -0.9305257363491D0*t3*(0.229522D-2*t7*t11
     &+0.1197032D-4*t128*t21-0.846048D-7*t132*t77)-0.3109D-1*t31*t43*
     &(0.543362D0*t7*t46-0.3383548D0*t128*t50+0.4593648D-1*t132*t119)
      vsigmaab(i) = 0.D0
      vsigmabb(i) = 0.D0
      else ! (.not.(rhoa.lt.tol).and..not.(rhob.lt.tol))
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigmaab = sigmaab1(i)
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmaaa+sigmabb+2.D0*sigmaab
      t4 = rhoa**(1.D0/3.D0)
      t5 = t4*rhoa
      t6 = rhoa**2
      t7 = t4**2
      t9 = 1/t7/t6
      t10 = sigmaaa*t9
      t12 = 1.D0+0.4D-2*t10
      t13 = 1/t12
      t16 = sigmaaa**2
      t17 = t6**2
      t20 = 1/t4/t17/rhoa
      t21 = t16*t20
      t22 = t12**2
      t23 = 1/t22
      t26 = 0.789518D0+0.229522D-2*t10*t13+0.105756D-4*t21*t23
      t29 = 1/rhoa
      t30 = t29**(1.D0/3.D0)
      t32 = 1.D0+0.1274696188700087D0*t30
      t33 = rhoa*t32
      t34 = t29**(1.D0/6.D0)
      t37 = dsqrt(t29)
      t39 = t30**2
      t41 = 0.1112037486309468D2*t34+0.3844746237447211D1*t30
     &+0.1644733775567609D1*t37+0.2405871291288192D0*t39
      t44 = 1.D0+0.321646831778707D2/t41
      t45 = dlog(t44)
      t47 = 1.D0+0.2D0*t10
      t48 = 1/t47
      t51 = t47**2
      t52 = 1/t51
      t55 = 0.820011D-1+0.543362D0*t10*t48-0.1148412D0*t21*t52
      t56 = t45*t55
      t59 = rhob**(1.D0/3.D0)
      t60 = t59*rhob
      t61 = rhob**2
      t62 = t59**2
      t64 = 1/t62/t61
      t65 = sigmabb*t64
      t67 = 1.D0+0.4D-2*t65
      t68 = 1/t67
      t71 = sigmabb**2
      t72 = t61**2
      t75 = 1/t59/t72/rhob
      t76 = t71*t75
      t77 = t67**2
      t78 = 1/t77
      t81 = 0.789518D0+0.229522D-2*t65*t68+0.105756D-4*t76*t78
      t84 = 1/rhob
      t85 = t84**(1.D0/3.D0)
      t87 = 1.D0+0.1274696188700087D0*t85
      t88 = rhob*t87
      t89 = t84**(1.D0/6.D0)
      t92 = dsqrt(t84)
      t94 = t85**2
      t96 = 0.1112037486309468D2*t89+0.3844746237447211D1*t85
     &+0.1644733775567609D1*t92+0.2405871291288192D0*t94
      t99 = 1.D0+0.321646831778707D2/t96
      t100 = dlog(t99)
      t102 = 1.D0+0.2D0*t65
      t103 = 1/t102
      t106 = t102**2
      t107 = 1/t106
      t110 = 0.820011D-1+0.543362D0*t65*t103-0.1148412D0*t76*t107
      t111 = t100*t110
      t114 = rhoa+rhob
      t115 = 1/t114
      t116 = t115**(1.D0/3.D0)
      t118 = 1.D0+0.1325688999052018D0*t116
      t119 = t115**(1.D0/6.D0)
      t122 = dsqrt(t115)
      t124 = t116**2
      t126 = 0.598255043577108D1*t119+0.2225569421150687D1*t116
     &+0.8004286349993634D0*t122+0.1897004325747559D0*t124
      t129 = 1.D0+0.160818243221511D2/t126
      t130 = dlog(t129)
      t132 = 0.62182D-1*t118*t130
      t134 = 1.D0+0.6901399211255825D-1*t116
      t139 = 0.8157414703487641D1*t119+0.2247591863577616D1*t116
     &+0.4300972471276643D0*t122+0.1911512595127338D0*t124
      t142 = 1.D0+0.2960857464321668D2/t139
      t143 = dlog(t142)
      t144 = t134*t143
      t146 = rhoa-1.D0*rhob
      t147 = t146*t115
      t148 = 1.D0+t147
      t149 = t148**(1.D0/3.D0)
      t152 = 1.D0-1.D0*t147
      t153 = t152**(1.D0/3.D0)
      t155 = t149*t148+t153*t152-2.D0
      t156 = t146**2
      t157 = t156**2
      t158 = t114**2
      t159 = t158**2
      t160 = 1/t159
      t161 = t157*t160
      t163 = 1.D0-1.D0*t161
      t166 = 0.3799574853701528D-1*t144*t155*t163
      t168 = 1.D0+0.1274696188700087D0*t116
      t173 = 0.1112037486309468D2*t119+0.3844746237447211D1*t116
     &+0.1644733775567609D1*t122+0.2405871291288192D0*t124
      t176 = 1.D0+0.321646831778707D2/t173
      t177 = dlog(t176)
      t180 = -0.3109D-1*t168*t177+t132
      t181 = t180*t155
      t183 = 0.1923661050931536D1*t181*t161
      t190 = t114*(-t132+t166+t183)+0.3109D-1*t33*t45+0.3109D-1*t88*t100
      t193 = 0.5D0*t10+0.5D0*t65
      t196 = 1.D0+0.3D-2*t10+0.3D-2*t65
      t197 = 1/t196
      t200 = t193**2
      t201 = t196**2
      t202 = 1/t201
      t205 = 0.955689D0+0.4731312D-2*t193*t197-0.19723284D-3*t200*t202
      zk(i) = -0.9305257363491D0*t5*t26-0.3109D-1*t33*t56
     &-0.9305257363491D0*t60*t81-0.3109D-1*t88*t111+t190*t205
      t212 = sigmaaa/t7/t6/rhoa
      t218 = t16/t4/t17/t6
      t222 = t17**2
      t225 = t16*sigmaaa/t222/rhoa
      t227 = 1/t22/t12
      t233 = t32*t45
      t236 = 1/t39
      t237 = t29*t236
      t240 = t41**2
      t241 = 1/t240
      t243 = t34**2
      t244 = t243**2
      t247 = 1/t6
      t258 = -0.1853395810515781D1/t244/t34*t247-0.128158207914907D1
     &*t236*t247-0.8223668877838045D0/t37*t247-0.1603914194192128D0
     &/t30*t247
      t259 = 1/t44
      t269 = 1/t51/t47
      t277 = 1/t158
      t278 = 1/t124*t277
      t279 = t278*t130
      t280 = 0.2747799777968419D-2*t279
      t281 = t126**2
      t284 = t119**2
      t285 = t284**2
      t288 = 1/t285/t119*t277
      t292 = 1/t122*t277
      t295 = 1/t116*t277
      t300 = t118/t281*(-0.99709173929518D0*t288-0.7418564737168958D0
     &*t278-0.4002143174996817D0*t292-0.1264669550498372D0*t295)/t129
      t301 = 0.1D1*t300
      t305 = 0.8740794299481065D-3*t278*t143*t155*t163
      t306 = t139**2
      t319 = 0.1124999956683108D1*t134/t306*(-0.135956911724794D1*t288
     &-0.7491972878592054D0*t278-0.2150486235638321D0*t292
     &-0.1274341730084892D0*t295)/t142*t155*t163
      t320 = t146*t277
      t321 = 1.D0*t320
      t325 = 1.D0*t115
      t329 = 0.1333333333333333D1*t149*(t115-t321)
     &+0.1333333333333333D1*t153*(-t325+t320)
      t334 = t156*t146*t160
      t335 = 4.D0*t334
      t338 = t157/t159/t114
      t339 = 4.D0*t338
      t346 = t173**2
      t363 = 0.1923661050931536D1*(0.1321010150222857D-2*t278*t177
     &+0.1D1*t168/t346*(-0.1853395810515781D1*t288-0.128158207914907D1
     &*t278-0.8223668877838045D0*t292-0.1603914194192128D0*t295)/t176
     &-0.2747799777968419D-2*t279-0.1D1*t300)*t155*t161
      t367 = t181*t334
      t370 = 0.7694644203726145D1*t181*t338
      t384 = t193*t202
      t389 = t200/t201/t196
      s1 = -0.12407009817988D1*t4*t26-0.9305257363491D0*t5*(
     &-0.6120586666666667D-2*t212*t13-0.3192085333333333D-4*t218*t23
     &+0.2256128D-6*t225*t227)-0.3109D-1*t233*t55
     &+0.1321010150222857D-2*t237*t56
      vrhoa(i) = s1+0.1D1*t33*t241*t258*t259*t55-0.3109D-1*t33*t45*(
     &-0.1448965333333333D1*t212*t48+0.9022794666666667D0*t218*t52
     &-0.12249728D0*t225*t269)+(-t132+t166+t183+t114*(t280+t301-t305
     &-t319+0.3799574853701528D-1*t144*t329*t163+0.3799574853701528D-1
     &*t144*t155*(-t335+t339)+t363+0.1923661050931536D1*t180*t329*t161
     &+0.7694644203726145D1*t367-t370)+0.3109D-1*t233
     &-0.1321010150222857D-2*t237*t45-0.1D1*t33*t241*t258*t259)*t205
     &+t190*(-0.6308416D-2*t212*t197+0.563804736D-3*t384*t212
     &-0.315572544D-5*t389*t212)
      t399 = sigmabb/t62/t61/rhob
      t405 = t71/t59/t72/t61
      t409 = t72**2
      t412 = t71*sigmabb/t409/rhob
      t414 = 1/t77/t67
      t420 = t87*t100
      t423 = 1/t94
      t424 = t84*t423
      t427 = t96**2
      t428 = 1/t427
      t430 = t89**2
      t431 = t430**2
      t434 = 1/t61
      t445 = -0.1853395810515781D1/t431/t89*t434-0.128158207914907D1
     &*t423*t434-0.8223668877838045D0/t92*t434-0.1603914194192128D0
     &/t85*t434
      t446 = 1/t99
      t456 = 1/t106/t102
      t469 = 0.1333333333333333D1*t149*(-t325-t321)
     &+0.1333333333333333D1*t153*(t115+t320)
      s1 = -0.12407009817988D1*t59*t81-0.9305257363491D0*t60*(
     &-0.6120586666666667D-2*t399*t68-0.3192085333333333D-4*t405*t78
     &+0.2256128D-6*t412*t414)-0.3109D-1*t420*t110
     &+0.1321010150222857D-2*t424*t111
      vrhob(i) = s1+0.1D1*t88*t428*t445*t446*t110-0.3109D-1*t88*t100*(
     &-0.1448965333333333D1*t399*t103+0.9022794666666667D0*t405*t107
     &-0.12249728D0*t412*t456)+(-t132+t166+t183+t114*(t280+t301-t305
     &-t319+0.3799574853701528D-1*t144*t469*t163+0.3799574853701528D-1
     &*t144*t155*(t335+t339)+t363+0.1923661050931536D1*t180*t469*t161
     &-0.7694644203726145D1*t367-t370)+0.3109D-1*t420
     &-0.1321010150222857D-2*t424*t100-0.1D1*t88*t428*t445*t446)*t205
     &+t190*(-0.6308416D-2*t399*t197+0.563804736D-3*t384*t399
     &-0.315572544D-5*t389*t399)
      t502 = sigmaaa*t20
      t506 = t16/t222
      vsigmaaa(i) = -0.9305257363491D0*t5*(0.229522D-2*t9*t13
     &+0.1197032D-4*t502*t23-0.846048D-7*t506*t227)-0.3109D-1*t33*t45*
     &(0.543362D0*t9*t48-0.3383548D0*t502*t52+0.4593648D-1*t506*t269)
     &+t190*(0.2365656D-2*t9*t197-0.211426776D-3*t384*t9
     &+0.118339704D-5*t389*t9)
      vsigmaab(i) = 0.D0
      t532 = sigmabb*t75
      t536 = t71/t409
      vsigmabb(i) = -0.9305257363491D0*t60*(0.229522D-2*t64*t68
     &+0.1197032D-4*t532*t78-0.846048D-7*t536*t414)-0.3109D-1*t88*t100
     &*(0.543362D0*t64*t103-0.3383548D0*t532*t107+0.4593648D-1*t536
     &*t456)+t190*(0.2365656D-2*t64*t197-0.211426776D-3*t384*t64
     &+0.118339704D-5*t389*t64)
      endif ! rhoa,rhob
      else ! rho
      zk(i) = 0.0d0
      vrhoa(i) = 0.0d0
      vrhob(i) = 0.0d0
      vsigmaaa(i) = 0.0d0
      vsigmaab(i) = 0.0d0
      vsigmabb(i) = 0.0d0
      endif ! rho
      enddo
      
      else if(ideriv.eq.2) then
      
      do i=1,npt
      rhoa = dmax1(0.D0,rhoa1(i))
      rhob = dmax1(0.D0,rhob1(i))
      rho = rhoa+rhob
      if(rho.gt.tol) then
      if(rhoa.lt.tol) then
      rho = rhob
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmabb
      t2 = rhob**(1.D0/3.D0)
      t3 = t2*rhob
      t4 = rhob**2
      t5 = t2**2
      t7 = 1/t5/t4
      t8 = sigmabb*t7
      t10 = 1.D0+0.4D-2*t8
      t11 = 1/t10
      t14 = sigmabb**2
      t15 = t4**2
      t18 = 1/t2/t15/rhob
      t19 = t14*t18
      t20 = t10**2
      t21 = 1/t20
      t24 = 0.789518D0+0.229522D-2*t8*t11+0.105756D-4*t19*t21
      t27 = 1/rhob
      t28 = t27**(1.D0/3.D0)
      t30 = 1.D0+0.1274696188700087D0*t28
      t31 = rhob*t30
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t39 = 0.1112037486309468D2*t32+0.3844746237447211D1*t28
     &+0.1644733775567609D1*t35+0.2405871291288192D0*t37
      t42 = 1.D0+0.321646831778707D2/t39
      t43 = dlog(t42)
      t45 = 1.D0+0.2D0*t8
      t46 = 1/t45
      t49 = t45**2
      t50 = 1/t49
      t53 = 0.820011D-1+0.543362D0*t8*t46-0.1148412D0*t19*t50
      t54 = t43*t53
      zk(i) = -0.9305257363491D0*t3*t24-0.3109D-1*t31*t54
      vrhoa(i) = 0.D0
      t59 = t4*rhob
      t62 = sigmabb/t5/t59
      t68 = t14/t2/t15/t4
      t71 = t14*sigmabb
      t72 = t15**2
      t75 = t71/t72/rhob
      t77 = 1/t20/t10
      t80 = -0.6120586666666667D-2*t62*t11-0.3192085333333333D-4*t68
     &*t21+0.2256128D-6*t75*t77
      t83 = t30*t43
      t86 = 1/t37
      t87 = t27*t86
      t90 = t39**2
      t91 = 1/t90
      t92 = t31*t91
      t93 = t32**2
      t94 = t93**2
      t95 = t94*t32
      t96 = 1/t95
      t97 = 1/t4
      t102 = 1/t35
      t105 = 1/t28
      t108 = -0.1853395810515781D1*t96*t97-0.128158207914907D1*t86*t97
     &-0.8223668877838045D0*t102*t97-0.1603914194192128D0*t105*t97
      t109 = 1/t42
      t110 = t108*t109
      t111 = t110*t53
      t119 = 1/t49/t45
      t122 = -0.1448965333333333D1*t62*t46+0.9022794666666667D0*t68
     &*t50-0.12249728D0*t75*t119
      t123 = t43*t122
      vrhob(i) = -0.12407009817988D1*t2*t24-0.9305257363491D0*t3*t80
     &-0.3109D-1*t83*t53+0.1321010150222857D-2*t87*t54+0.1D1*t92*t111
     &-0.3109D-1*t31*t123
      vsigmaaa(i) = 0.D0
      vsigmaab(i) = 0.D0
      t128 = sigmabb*t18
      t131 = 1/t72
      t132 = t14*t131
      vsigmabb(i) = -0.9305257363491D0*t3*(0.229522D-2*t7*t11
     &+0.1197032D-4*t128*t21-0.846048D-7*t132*t77)-0.3109D-1*t31*t43*
     &(0.543362D0*t7*t46-0.3383548D0*t128*t50+0.4593648D-1*t132*t119)
      v2rhoa2(i) = 0.D0
      v2rhoab(i) = 0.D0
      t155 = sigmabb/t5/t15
      t161 = t14/t2/t15/t59
      t164 = t72*t4
      t166 = t71/t164
      t169 = t14**2
      t173 = t169/t5/t72/t15
      t174 = t20**2
      t175 = 1/t174
      t186 = 1/t59
      t188 = 1/t37/t27
      t200 = t108**2
      t207 = 1/t15
      t233 = t90**2
      t236 = t42**2
      t251 = t49**2
      t252 = 1/t251
      s1 = -0.4135669939329333D0/t5*t24-0.24814019635976D1*t2*t80
     &-0.9305257363491D0*t3*(0.2244215111111111D-1*t155*t11
     &+0.1368791466666667D-3*t161*t21-0.2711493404444444D-5*t166*t77
     &+0.72196096D-8*t173*t175)+0.2D1*t30*t91*t111-0.6218D-1*t83*t122
     &+0.8806734334819047D-3*t186*t188*t54
      v2rhob2(i) = s1-0.8497974591333914D-1*t87*t91*t111
     &+0.2642020300445714D-2*t87*t123-0.2D1*t31/t90/t39*t200*t109*t53
     &+0.1D1*t92*(-0.1544496508763151D1/t95/t27*t207
     &+0.3706791621031562D1*t96*t186-0.854388052766047D0*t188*t207
     &+0.2563164158298141D1*t86*t186-0.4111834438919023D0/t35/t27*t207
     &+0.1644733775567609D1*t102*t186-0.5346380647307093D-1/t28/t27
     &*t207+0.3207828388384256D0*t105*t186)*t109*t53
     &+0.321646831778707D2*t31/t233*t200/t236*t53+0.2D1*t92*t110*t122
     &-0.3109D-1*t31*t43*(0.5312872888888889D1*t155*t46
     &-0.6487218133333333D1*t161*t50+0.2064906951111111D1*t166*t119
     &-0.195995648D0*t173*t252)
      v2sigmaaa2(i) = 0.D0
      v2sigmaaaab(i) = 0.D0
      v2sigmaaabb(i) = 0.D0
      v2sigmaab2(i) = 0.D0
      v2sigmaabbb(i) = 0.D0
      t261 = sigmabb*t131
      t266 = t14/t5/t164
      v2sigmabb2(i) = -0.9305257363491D0*t3*(0.278944D-5*t18*t21
     &-0.26497216D-6*t261*t77+0.10152576D-8*t266*t175)-0.3109D-1*t31
     &*t43*(-0.4470272D0*t18*t50+0.22721488D0*t261*t119-0.27561888D-1
     &*t266*t252)
      elseif(rhob.lt.tol) then
      rho = rhoa
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigma = sigmaaa
      t2 = rhoa**(1.D0/3.D0)
      t3 = t2*rhoa
      t4 = rhoa**2
      t5 = t2**2
      t7 = 1/t5/t4
      t8 = sigmaaa*t7
      t10 = 1.D0+0.4D-2*t8
      t11 = 1/t10
      t14 = sigmaaa**2
      t15 = t4**2
      t18 = 1/t2/t15/rhoa
      t19 = t14*t18
      t20 = t10**2
      t21 = 1/t20
      t24 = 0.789518D0+0.229522D-2*t8*t11+0.105756D-4*t19*t21
      t27 = 1/rhoa
      t28 = t27**(1.D0/3.D0)
      t30 = 1.D0+0.1274696188700087D0*t28
      t31 = rhoa*t30
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t39 = 0.1112037486309468D2*t32+0.3844746237447211D1*t28
     &+0.1644733775567609D1*t35+0.2405871291288192D0*t37
      t42 = 1.D0+0.321646831778707D2/t39
      t43 = dlog(t42)
      t45 = 1.D0+0.2D0*t8
      t46 = 1/t45
      t49 = t45**2
      t50 = 1/t49
      t53 = 0.820011D-1+0.543362D0*t8*t46-0.1148412D0*t19*t50
      t54 = t43*t53
      zk(i) = -0.9305257363491D0*t3*t24-0.3109D-1*t31*t54
      t59 = t4*rhoa
      t62 = sigmaaa/t5/t59
      t68 = t14/t2/t15/t4
      t71 = t14*sigmaaa
      t72 = t15**2
      t75 = t71/t72/rhoa
      t77 = 1/t20/t10
      t80 = -0.6120586666666667D-2*t62*t11-0.3192085333333333D-4*t68
     &*t21+0.2256128D-6*t75*t77
      t83 = t30*t43
      t86 = 1/t37
      t87 = t27*t86
      t90 = t39**2
      t91 = 1/t90
      t92 = t31*t91
      t93 = t32**2
      t94 = t93**2
      t95 = t94*t32
      t96 = 1/t95
      t97 = 1/t4
      t102 = 1/t35
      t105 = 1/t28
      t108 = -0.1853395810515781D1*t96*t97-0.128158207914907D1*t86*t97
     &-0.8223668877838045D0*t102*t97-0.1603914194192128D0*t105*t97
      t109 = 1/t42
      t110 = t108*t109
      t111 = t110*t53
      t119 = 1/t49/t45
      t122 = -0.1448965333333333D1*t62*t46+0.9022794666666667D0*t68
     &*t50-0.12249728D0*t75*t119
      t123 = t43*t122
      vrhoa(i) = -0.12407009817988D1*t2*t24-0.9305257363491D0*t3*t80
     &-0.3109D-1*t83*t53+0.1321010150222857D-2*t87*t54+0.1D1*t92*t111
     &-0.3109D-1*t31*t123
      vrhob(i) = 0.D0
      t128 = sigmaaa*t18
      t131 = 1/t72
      t132 = t14*t131
      vsigmaaa(i) = -0.9305257363491D0*t3*(0.229522D-2*t7*t11
     &+0.1197032D-4*t128*t21-0.846048D-7*t132*t77)-0.3109D-1*t31*t43*
     &(0.543362D0*t7*t46-0.3383548D0*t128*t50+0.4593648D-1*t132*t119)
      vsigmaab(i) = 0.D0
      vsigmabb(i) = 0.D0
      t155 = sigmaaa/t5/t15
      t161 = t14/t2/t15/t59
      t164 = t72*t4
      t166 = t71/t164
      t169 = t14**2
      t173 = t169/t5/t72/t15
      t174 = t20**2
      t175 = 1/t174
      t186 = 1/t59
      t188 = 1/t37/t27
      t200 = t108**2
      t207 = 1/t15
      t233 = t90**2
      t236 = t42**2
      t251 = t49**2
      t252 = 1/t251
      s1 = -0.4135669939329333D0/t5*t24-0.24814019635976D1*t2*t80
     &-0.9305257363491D0*t3*(0.2244215111111111D-1*t155*t11
     &+0.1368791466666667D-3*t161*t21-0.2711493404444444D-5*t166*t77
     &+0.72196096D-8*t173*t175)+0.2D1*t30*t91*t111-0.6218D-1*t83*t122
     &+0.8806734334819047D-3*t186*t188*t54
      v2rhoa2(i) = s1-0.8497974591333914D-1*t87*t91*t111
     &+0.2642020300445714D-2*t87*t123-0.2D1*t31/t90/t39*t200*t109*t53
     &+0.1D1*t92*(-0.1544496508763151D1/t95/t27*t207
     &+0.3706791621031562D1*t96*t186-0.854388052766047D0*t188*t207
     &+0.2563164158298141D1*t86*t186-0.4111834438919023D0/t35/t27*t207
     &+0.1644733775567609D1*t102*t186-0.5346380647307093D-1/t28/t27
     &*t207+0.3207828388384256D0*t105*t186)*t109*t53
     &+0.321646831778707D2*t31/t233*t200/t236*t53+0.2D1*t92*t110*t122
     &-0.3109D-1*t31*t43*(0.5312872888888889D1*t155*t46
     &-0.6487218133333333D1*t161*t50+0.2064906951111111D1*t166*t119
     &-0.195995648D0*t173*t252)
      v2rhob2(i) = 0.D0
      v2rhoab(i) = 0.D0
      t261 = sigmaaa*t131
      t266 = t14/t5/t164
      v2sigmaaa2(i) = -0.9305257363491D0*t3*(0.278944D-5*t18*t21
     &-0.26497216D-6*t261*t77+0.10152576D-8*t266*t175)-0.3109D-1*t31
     &*t43*(-0.4470272D0*t18*t50+0.22721488D0*t261*t119-0.27561888D-1
     &*t266*t252)
      v2sigmaaaab(i) = 0.D0
      v2sigmaaabb(i) = 0.D0
      v2sigmaab2(i) = 0.D0
      v2sigmaabbb(i) = 0.D0
      v2sigmabb2(i) = 0.D0
      else ! (.not.(rhoa.lt.tol).and..not.(rhob.lt.tol))
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigmaab = sigmaab1(i)
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmaaa+sigmabb+2.D0*sigmaab
      t4 = rhoa**(1.D0/3.D0)
      t5 = t4*rhoa
      t6 = rhoa**2
      t7 = t4**2
      t9 = 1/t7/t6
      t10 = sigmaaa*t9
      t12 = 1.D0+0.4D-2*t10
      t13 = 1/t12
      t16 = sigmaaa**2
      t17 = t6**2
      t20 = 1/t4/t17/rhoa
      t21 = t16*t20
      t22 = t12**2
      t23 = 1/t22
      t26 = 0.789518D0+0.229522D-2*t10*t13+0.105756D-4*t21*t23
      t29 = 1/rhoa
      t30 = t29**(1.D0/3.D0)
      t32 = 1.D0+0.1274696188700087D0*t30
      t33 = rhoa*t32
      t34 = t29**(1.D0/6.D0)
      t37 = dsqrt(t29)
      t39 = t30**2
      t41 = 0.1112037486309468D2*t34+0.3844746237447211D1*t30
     &+0.1644733775567609D1*t37+0.2405871291288192D0*t39
      t44 = 1.D0+0.321646831778707D2/t41
      t45 = dlog(t44)
      t47 = 1.D0+0.2D0*t10
      t48 = 1/t47
      t51 = t47**2
      t52 = 1/t51
      t55 = 0.820011D-1+0.543362D0*t10*t48-0.1148412D0*t21*t52
      t56 = t45*t55
      t59 = rhob**(1.D0/3.D0)
      t60 = t59*rhob
      t61 = rhob**2
      t62 = t59**2
      t64 = 1/t62/t61
      t65 = sigmabb*t64
      t67 = 1.D0+0.4D-2*t65
      t68 = 1/t67
      t71 = sigmabb**2
      t72 = t61**2
      t75 = 1/t59/t72/rhob
      t76 = t71*t75
      t77 = t67**2
      t78 = 1/t77
      t81 = 0.789518D0+0.229522D-2*t65*t68+0.105756D-4*t76*t78
      t84 = 1/rhob
      t85 = t84**(1.D0/3.D0)
      t87 = 1.D0+0.1274696188700087D0*t85
      t88 = rhob*t87
      t89 = t84**(1.D0/6.D0)
      t92 = dsqrt(t84)
      t94 = t85**2
      t96 = 0.1112037486309468D2*t89+0.3844746237447211D1*t85
     &+0.1644733775567609D1*t92+0.2405871291288192D0*t94
      t99 = 1.D0+0.321646831778707D2/t96
      t100 = dlog(t99)
      t102 = 1.D0+0.2D0*t65
      t103 = 1/t102
      t106 = t102**2
      t107 = 1/t106
      t110 = 0.820011D-1+0.543362D0*t65*t103-0.1148412D0*t76*t107
      t111 = t100*t110
      t114 = rhoa+rhob
      t115 = 1/t114
      t116 = t115**(1.D0/3.D0)
      t118 = 1.D0+0.1325688999052018D0*t116
      t119 = t115**(1.D0/6.D0)
      t122 = dsqrt(t115)
      t124 = t116**2
      t126 = 0.598255043577108D1*t119+0.2225569421150687D1*t116
     &+0.8004286349993634D0*t122+0.1897004325747559D0*t124
      t129 = 1.D0+0.160818243221511D2/t126
      t130 = dlog(t129)
      t132 = 0.62182D-1*t118*t130
      t134 = 1.D0+0.6901399211255825D-1*t116
      t139 = 0.8157414703487641D1*t119+0.2247591863577616D1*t116
     &+0.4300972471276643D0*t122+0.1911512595127338D0*t124
      t142 = 1.D0+0.2960857464321668D2/t139
      t143 = dlog(t142)
      t144 = t134*t143
      t146 = rhoa-1.D0*rhob
      t147 = t146*t115
      t148 = 1.D0+t147
      t149 = t148**(1.D0/3.D0)
      t152 = 1.D0-1.D0*t147
      t153 = t152**(1.D0/3.D0)
      t155 = t149*t148+t153*t152-2.D0
      t156 = t146**2
      t157 = t156**2
      t158 = t114**2
      t159 = t158**2
      t160 = 1/t159
      t161 = t157*t160
      t163 = 1.D0-1.D0*t161
      t164 = t155*t163
      t166 = 0.3799574853701528D-1*t144*t164
      t168 = 1.D0+0.1274696188700087D0*t116
      t173 = 0.1112037486309468D2*t119+0.3844746237447211D1*t116
     &+0.1644733775567609D1*t122+0.2405871291288192D0*t124
      t176 = 1.D0+0.321646831778707D2/t173
      t177 = dlog(t176)
      t180 = -0.3109D-1*t168*t177+t132
      t181 = t180*t155
      t183 = 0.1923661050931536D1*t181*t161
      t190 = t114*(-t132+t166+t183)+0.3109D-1*t33*t45+0.3109D-1*t88*t100
      t193 = 0.5D0*t10+0.5D0*t65
      t196 = 1.D0+0.3D-2*t10+0.3D-2*t65
      t197 = 1/t196
      t200 = t193**2
      t201 = t196**2
      t202 = 1/t201
      t205 = 0.955689D0+0.4731312D-2*t193*t197-0.19723284D-3*t200*t202
      zk(i) = -0.9305257363491D0*t5*t26-0.3109D-1*t33*t56
     &-0.9305257363491D0*t60*t81-0.3109D-1*t88*t111+t190*t205
      t209 = t6*rhoa
      t211 = 1/t7/t209
      t212 = sigmaaa*t211
      t217 = 1/t4/t17/t6
      t218 = t16*t217
      t221 = t16*sigmaaa
      t222 = t17**2
      t224 = 1/t222/rhoa
      t225 = t221*t224
      t227 = 1/t22/t12
      t230 = -0.6120586666666667D-2*t212*t13-0.3192085333333333D-4
     &*t218*t23+0.2256128D-6*t225*t227
      t233 = t32*t45
      t236 = 1/t39
      t237 = t29*t236
      t240 = t41**2
      t241 = 1/t240
      t242 = t33*t241
      t243 = t34**2
      t244 = t243**2
      t245 = t244*t34
      t246 = 1/t245
      t247 = 1/t6
      t252 = 1/t37
      t255 = 1/t30
      t258 = -0.1853395810515781D1*t246*t247-0.128158207914907D1*t236
     &*t247-0.8223668877838045D0*t252*t247-0.1603914194192128D0*t255
     &*t247
      t259 = 1/t44
      t260 = t258*t259
      t261 = t260*t55
      t269 = 1/t51/t47
      t272 = -0.1448965333333333D1*t212*t48+0.9022794666666667D0*t218
     &*t52-0.12249728D0*t225*t269
      t273 = t45*t272
      t276 = 1/t124
      t277 = 1/t158
      t278 = t276*t277
      t279 = t278*t130
      t280 = 0.2747799777968419D-2*t279
      t281 = t126**2
      t282 = 1/t281
      t283 = t118*t282
      t284 = t119**2
      t285 = t284**2
      t286 = t285*t119
      t287 = 1/t286
      t288 = t287*t277
      t291 = 1/t122
      t292 = t291*t277
      t294 = 1/t116
      t295 = t294*t277
      t297 = -0.99709173929518D0*t288-0.7418564737168958D0*t278
     &-0.4002143174996817D0*t292-0.1264669550498372D0*t295
      t298 = 1/t129
      t300 = t283*t297*t298
      t301 = 0.1D1*t300
      t302 = t143*t155
      t303 = t302*t163
      t304 = t278*t303
      t305 = 0.8740794299481065D-3*t304
      t306 = t139**2
      t307 = 1/t306
      t308 = t134*t307
      t313 = -0.135956911724794D1*t288-0.7491972878592054D0*t278
     &-0.2150486235638321D0*t292-0.1274341730084892D0*t295
      t314 = t308*t313
      t315 = 1/t142
      t316 = t315*t155
      t317 = t316*t163
      t318 = t314*t317
      t319 = 0.1124999956683108D1*t318
      t320 = t146*t277
      t321 = 1.D0*t320
      t322 = t115-t321
      t325 = 1.D0*t115
      t326 = -t325+t320
      t329 = 0.1333333333333333D1*t149*t322+0.1333333333333333D1*t153
     &*t326
      t331 = t144*t329*t163
      t332 = 0.3799574853701528D-1*t331
      t333 = t156*t146
      t334 = t333*t160
      t335 = 4.D0*t334
      t337 = 1/t159/t114
      t338 = t157*t337
      t339 = 4.D0*t338
      t340 = -t335+t339
      t342 = t144*t155*t340
      t343 = 0.3799574853701528D-1*t342
      t346 = t173**2
      t347 = 1/t346
      t348 = t168*t347
      t353 = -0.1853395810515781D1*t288-0.128158207914907D1*t278
     &-0.8223668877838045D0*t292-0.1603914194192128D0*t295
      t354 = 1/t176
      t360 = 0.1321010150222857D-2*t278*t177+0.1D1*t348*t353*t354
     &-0.2747799777968419D-2*t279-0.1D1*t300
      t361 = t360*t155
      t362 = t361*t161
      t363 = 0.1923661050931536D1*t362
      t364 = t180*t329
      t365 = t364*t161
      t366 = 0.1923661050931536D1*t365
      t367 = t181*t334
      t369 = t181*t338
      t370 = 0.7694644203726145D1*t369
      t377 = t241*t258*t259
      t380 = -t132+t166+t183+t114*(t280+t301-t305-t319+t332+t343+t363
     &+t366+0.7694644203726145D1*t367-t370)+0.3109D-1*t233
     &-0.1321010150222857D-2*t237*t45-0.1D1*t33*t377
      t384 = t193*t202
      t388 = 1/t201/t196
      t389 = t200*t388
      t392 = -0.6308416D-2*t212*t197+0.563804736D-3*t384*t212
     &-0.315572544D-5*t389*t212
      vrhoa(i) = -0.12407009817988D1*t4*t26-0.9305257363491D0*t5*t230
     &-0.3109D-1*t233*t55+0.1321010150222857D-2*t237*t56+0.1D1*t242
     &*t261-0.3109D-1*t33*t273+t380*t205+t190*t392
      t396 = t61*rhob
      t398 = 1/t62/t396
      t399 = sigmabb*t398
      t404 = 1/t59/t72/t61
      t405 = t71*t404
      t408 = t71*sigmabb
      t409 = t72**2
      t411 = 1/t409/rhob
      t412 = t408*t411
      t414 = 1/t77/t67
      t417 = -0.6120586666666667D-2*t399*t68-0.3192085333333333D-4
     &*t405*t78+0.2256128D-6*t412*t414
      t420 = t87*t100
      t423 = 1/t94
      t424 = t84*t423
      t427 = t96**2
      t428 = 1/t427
      t429 = t88*t428
      t430 = t89**2
      t431 = t430**2
      t432 = t431*t89
      t433 = 1/t432
      t434 = 1/t61
      t439 = 1/t92
      t442 = 1/t85
      t445 = -0.1853395810515781D1*t433*t434-0.128158207914907D1*t423
     &*t434-0.8223668877838045D0*t439*t434-0.1603914194192128D0*t442
     &*t434
      t446 = 1/t99
      t447 = t445*t446
      t448 = t447*t110
      t456 = 1/t106/t102
      t459 = -0.1448965333333333D1*t399*t103+0.9022794666666667D0*t405
     &*t107-0.12249728D0*t412*t456
      t460 = t100*t459
      t463 = -t325-t321
      t466 = t115+t320
      t469 = 0.1333333333333333D1*t149*t463+0.1333333333333333D1*t153
     &*t466
      t471 = t144*t469*t163
      t472 = 0.3799574853701528D-1*t471
      t473 = t335+t339
      t475 = t144*t155*t473
      t476 = 0.3799574853701528D-1*t475
      t477 = t180*t469
      t478 = t477*t161
      t479 = 0.1923661050931536D1*t478
      t487 = t428*t445*t446
      t490 = -t132+t166+t183+t114*(t280+t301-t305-t319+t472+t476+t363
     &+t479-0.7694644203726145D1*t367-t370)+0.3109D-1*t420
     &-0.1321010150222857D-2*t424*t100-0.1D1*t88*t487
      t498 = -0.6308416D-2*t399*t197+0.563804736D-3*t384*t399
     &-0.315572544D-5*t389*t399
      vrhob(i) = -0.12407009817988D1*t59*t81-0.9305257363491D0*t60
     &*t417-0.3109D-1*t420*t110+0.1321010150222857D-2*t424*t111+0.1D1
     &*t429*t448-0.3109D-1*t88*t460+t490*t205+t190*t498
      t502 = sigmaaa*t20
      t505 = 1/t222
      t506 = t16*t505
      t509 = 0.229522D-2*t9*t13+0.1197032D-4*t502*t23-0.846048D-7*t506
     &*t227
      t518 = 0.543362D0*t9*t48-0.3383548D0*t502*t52+0.4593648D-1*t506
     &*t269
      t519 = t45*t518
      t528 = 0.2365656D-2*t9*t197-0.211426776D-3*t384*t9
     &+0.118339704D-5*t389*t9
      vsigmaaa(i) = -0.9305257363491D0*t5*t509-0.3109D-1*t33*t519+t190
     &*t528
      vsigmaab(i) = 0.D0
      t532 = sigmabb*t75
      t535 = 1/t409
      t536 = t71*t535
      t539 = 0.229522D-2*t64*t68+0.1197032D-4*t532*t78-0.846048D-7
     &*t536*t414
      t548 = 0.543362D0*t64*t103-0.3383548D0*t532*t107+0.4593648D-1
     &*t536*t456
      t549 = t100*t548
      t558 = 0.2365656D-2*t64*t197-0.211426776D-3*t384*t64
     &+0.118339704D-5*t389*t64
      vsigmabb(i) = -0.9305257363491D0*t60*t539-0.3109D-1*t88*t549
     &+t190*t558
      t563 = t297**2
      t565 = t118/t281/t126*t563*t298
      t566 = 0.2D1*t565
      t569 = 1/t286/t115*t160
      t572 = 1/t158/t114
      t573 = t287*t572
      t577 = 1/t124/t115*t160
      t579 = t276*t572
      t583 = 1/t122/t115*t160
      t585 = t291*t572
      t589 = 1/t116/t115*t160
      t591 = t294*t572
      t595 = t283*(-0.8309097827459833D0*t569+0.199418347859036D1*t573
     &-0.4945709824779306D0*t577+0.1483712947433792D1*t579
     &-0.2001071587498409D0*t583+0.8004286349993634D0*t585
     &-0.4215565168327908D-1*t589+0.2529339100996745D0*t591)*t298
      t596 = 0.1D1*t595
      t597 = t281**2
      t600 = t129**2
      t603 = t118/t597*t563/t600
      t604 = 0.160818243221511D2*t603
      t616 = 0.1124999956683108D1*t308*(-0.1132974264373283D1*t569
     &+0.271913823449588D1*t573-0.4994648585728036D0*t577
     &+0.1498394575718411D1*t579-0.1075243117819161D0*t583
     &+0.4300972471276643D0*t585-0.4247805766949639D-1*t589
     &+0.2548683460169784D0*t591)*t317
      t618 = 0.5827196199654043D-3*t577*t303
      t621 = t278*t143*t329*t163
      t623 = t577*t130
      t624 = 0.1831866518645613D-2*t623
      t625 = t579*t130
      t626 = 0.5495599555936838D-2*t625
      t628 = t278*t302*t340
      t633 = t313**2
      t636 = 0.2249999913366216D1*t134/t306/t139*t633*t317
      t638 = 0.1748158859896213D-2*t579*t303
      t643 = 0.5176049209143758D-1*t278*t307*t313*t315*t164
      t646 = t278*t282*t297*t298
      t647 = 0.8837926660346786D-1*t646
      t659 = t353**2
      t675 = t346**2
      t678 = t176**2
      t689 = 0.8806734334819047D-3*t577*t177-0.2642020300445714D-2
     &*t579*t177-0.8497974591333914D-1*t278*t347*t353*t354-0.2D1*t168
     &/t346/t173*t659*t354+0.1D1*t348*(-0.1544496508763151D1*t569
     &+0.3706791621031562D1*t573-0.854388052766047D0*t577
     &+0.2563164158298141D1*t579-0.4111834438919023D0*t583
     &+0.1644733775567609D1*t585-0.5346380647307093D-1*t589
     &+0.3207828388384256D0*t591)*t354+0.321646831778707D2*t168/t675
     &*t659/t678-0.1831866518645613D-2*t623+0.5495599555936838D-2*t625
     &+0.8837926660346786D-1*t646+0.2D1*t565-0.1D1*t595
     &-0.160818243221511D2*t603
      t692 = 0.1923661050931536D1*t689*t155*t161
      t693 = -t566+t596+t604-t616-t618-0.1748158859896213D-2*t621+t624
     &-t626-0.1748158859896213D-2*t628+t636+t638+t643-t647+t692
      t694 = t156*t160
      t695 = 12.D0*t694
      t696 = t333*t337
      t697 = 32.D0*t696
      t700 = t157/t159/t158
      t701 = 20.D0*t700
      t706 = t149**2
      t707 = 1/t706
      t708 = t322**2
      t711 = 2.D0*t277
      t713 = 2.D0*t146*t572
      t714 = -t711+t713
      t717 = t153**2
      t718 = 1/t717
      t719 = t326**2
      t725 = 0.4444444444444444D0*t707*t708+0.1333333333333333D1*t149
     &*t714+0.4444444444444444D0*t718*t719-0.1333333333333333D1*t153
     &*t714
      t734 = t314*t315*t329*t163
      t736 = t181*t694
      t737 = 0.2308393261117844D2*t736
      t738 = t364*t338
      t740 = t181*t696
      t743 = 0.3847322101863073D2*t181*t700
      t744 = t306**2
      t748 = t142**2
      t753 = 0.3330964519106732D2*t134/t744*t633/t748*t155*t163
      t755 = t314*t316*t340
      t757 = t364*t334
      t763 = t360*t329*t161
      t765 = t361*t334
      t768 = 0.1538928840745229D2*t361*t338
      t769 = 0.3799574853701528D-1*t144*t155*(-t695+t697-t701)
     &+0.3799574853701528D-1*t144*t725*t163+0.7599149707403056D-1*t144
     &*t329*t340-0.2249999913366216D1*t734+t737-0.1538928840745229D2
     &*t738-0.6155715362980916D2*t740+t743-t753-0.2249999913366216D1
     &*t755+0.1538928840745229D2*t757+0.1923661050931536D1*t180*t725
     &*t161+0.3847322101863073D1*t763+0.1538928840745229D2*t765-t768
      t772 = 1/t209
      t774 = 1/t39/t29
      t775 = t772*t774
      t780 = t32*t241
      t783 = t240**2
      t784 = 1/t783
      t785 = t258**2
      t787 = t44**2
      t788 = 1/t787
      t794 = 1/t17
      t815 = -0.1544496508763151D1/t245/t29*t794+0.3706791621031562D1
     &*t246*t772-0.854388052766047D0*t774*t794+0.2563164158298141D1
     &*t236*t772-0.4111834438919023D0/t37/t29*t794
     &+0.1644733775567609D1*t252*t772-0.5346380647307093D-1/t30/t29
     &*t794+0.3207828388384256D0*t255*t772
      t821 = 1/t240/t41
      t826 = 0.5495599555936838D-2*t279
      t828 = 0.2D1*t300
      t830 = 0.1538928840745229D2*t369
      t833 = 0.1748158859896213D-2*t304
      t834 = 0.2249999913366216D1*t318
      t835 = 0.3847322101863073D1*t362
      t836 = t114*(t693+t769)-0.8806734334819047D-3*t775*t45
     &+0.8497974591333914D-1*t237*t377-0.2D1*t780*t260
     &-0.321646831778707D2*t33*t784*t785*t788-0.1D1*t33*t241*t815*t259
     &+0.2D1*t33*t821*t785*t259+t826+0.7599149707403056D-1*t331+t828
     &+0.1538928840745229D2*t367-t830+0.3847322101863073D1*t365
     &+0.7599149707403056D-1*t342-t833-t834+t835
      t861 = sigmaaa/t7/t17
      t867 = t16/t4/t17/t209
      t870 = t222*t6
      t872 = t221/t870
      t875 = t16**2
      t879 = t875/t7/t222/t17
      t880 = t22**2
      t881 = 1/t880
      t905 = t51**2
      t906 = 1/t905
      t917 = t193*t388
      t922 = t201**2
      t924 = t200/t922
      s1 = t836*t205+0.2D1*t242*t260*t272+0.1D1*t242*t815*t259*t55
     &+0.8806734334819047D-3*t775*t56-0.8497974591333914D-1*t237*t241
     &*t261-0.2D1*t33*t821*t785*t259*t55+0.2642020300445714D-2*t237
     &*t273+0.2D1*t780*t261
      v2rhoa2(i) = s1-0.9305257363491D0*t5*(0.2244215111111111D-1*t861
     &*t13+0.1368791466666667D-3*t867*t23-0.2711493404444444D-5*t872
     &*t227+0.72196096D-8*t879*t881)-0.6218D-1*t233*t272
     &-0.4135669939329333D0/t7*t26-0.24814019635976D1*t4*t230
     &+0.321646831778707D2*t33*t784*t785*t788*t55-0.3109D-1*t33*t45*
     &(0.5312872888888889D1*t861*t48-0.6487218133333333D1*t867*t52
     &+0.2064906951111111D1*t872*t269-0.195995648D0*t879*t906)+t190*
     &(0.2313085866666667D-1*t861*t197-0.802206976D-3*t867*t202
     &+0.17436143616D-4*t917*t867-0.2067284032D-2*t384*t861
     &-0.7573741056D-7*t924*t867+0.1157099328D-4*t389*t861)+2.D0*t380
     &*t392
      t939 = t314*t315*t469*t163
      t941 = -t566+t596+t604-t616-t618+t624-t626+t636+t638+t643-t647
     &+t692-0.2249999913366216D1*t939+t737
      t952 = t314*t316*t473
      t955 = t360*t469*t161
      t957 = t463**2
      t960 = t711+t713
      t963 = t466**2
      t969 = 0.4444444444444444D0*t707*t957+0.1333333333333333D1*t149
     &*t960+0.4444444444444444D0*t718*t963-0.1333333333333333D1*t153
     &*t960
      t973 = t477*t334
      t975 = t477*t338
      t982 = t278*t143*t469*t163
      t985 = t278*t302*t473
      t987 = 0.6155715362980916D2*t740+t743-t753-0.1538928840745229D2
     &*t765-t768+0.7599149707403056D-1*t144*t469*t473
     &+0.3799574853701528D-1*t144*t155*(-t695-t697-t701)
     &-0.2249999913366216D1*t952+0.3847322101863073D1*t955
     &+0.1923661050931536D1*t180*t969*t161-0.1538928840745229D2*t973
     &-0.1538928840745229D2*t975+0.3799574853701528D-1*t144*t969*t163
     &-0.1748158859896213D-2*t982-0.1748158859896213D-2*t985
      t990 = t87*t428
      t993 = 1/t396
      t995 = 1/t94/t84
      t996 = t993*t995
      t1002 = 1/t427/t96
      t1003 = t445**2
      t1010 = 1/t72
      t1031 = -0.1544496508763151D1/t432/t84*t1010
     &+0.3706791621031562D1*t433*t993-0.854388052766047D0*t995*t1010
     &+0.2563164158298141D1*t423*t993-0.4111834438919023D0/t92/t84
     &*t1010+0.1644733775567609D1*t439*t993-0.5346380647307093D-1/t85
     &/t84*t1010+0.3207828388384256D0*t442*t993
      t1036 = t427**2
      t1037 = 1/t1036
      t1039 = t99**2
      t1040 = 1/t1039
      t1044 = t826+t828-0.1538928840745229D2*t367-t830-t833-t834+t835
     &+0.7599149707403056D-1*t471+0.7599149707403056D-1*t475
     &+0.3847322101863073D1*t478+t114*(t941+t987)-0.2D1*t990*t447
     &-0.8806734334819047D-3*t996*t100+0.8497974591333914D-1*t424*t487
     &+0.2D1*t88*t1002*t1003*t446-0.1D1*t88*t428*t1031*t446
     &-0.321646831778707D2*t88*t1037*t1003*t1040
      t1053 = sigmabb/t62/t72
      t1059 = t71/t59/t72/t396
      t1062 = t409*t61
      t1064 = t408/t1062
      t1067 = t71**2
      t1071 = t1067/t62/t409/t72
      t1072 = t77**2
      t1073 = 1/t1072
      t1101 = t106**2
      t1102 = 1/t1101
      s1 = t1044*t205-0.4135669939329333D0/t62*t81-0.24814019635976D1
     &*t59*t417-0.9305257363491D0*t60*(0.2244215111111111D-1*t1053*t68
     &+0.1368791466666667D-3*t1059*t78-0.2711493404444444D-5*t1064
     &*t414+0.72196096D-8*t1071*t1073)-0.6218D-1*t420*t459+0.2D1*t990
     &*t448+0.2642020300445714D-2*t424*t460+0.8806734334819047D-3*t996
     &*t111
      v2rhob2(i) = s1-0.8497974591333914D-1*t424*t428*t448-0.2D1*t88
     &*t1002*t1003*t446*t110-0.3109D-1*t88*t100*(0.5312872888888889D1
     &*t1053*t103-0.6487218133333333D1*t1059*t107+0.2064906951111111D1
     &*t1064*t456-0.195995648D0*t1071*t1102)+0.1D1*t429*t1031*t446
     &*t110+0.2D1*t429*t447*t459+0.321646831778707D2*t88*t1037*t1003
     &*t1040*t110+2.D0*t490*t498+t190*(0.2313085866666667D-1*t1053
     &*t197-0.802206976D-3*t1059*t202+0.17436143616D-4*t917*t1059
     &-0.2067284032D-2*t384*t1053-0.7573741056D-7*t924*t1059
     &+0.1157099328D-4*t389*t1053)
      t1142 = -t566+t596+t604-t616-t618-0.8740794299481065D-3*t621
     &+t624-t626-0.8740794299481065D-3*t628+t636+t638+t643-t647+t692
     &-0.1124999956683108D1*t939-0.1124999956683108D1*t734
     &-0.2308393261117844D2*t736
      t1166 = 0.4444444444444444D0*t707*t322*t463+0.2666666666666667D1
     &*t149*t146*t572+0.4444444444444444D0*t718*t326*t466
     &-0.2666666666666667D1*t153*t146*t572
      t1182 = -0.7694644203726145D1*t738+t743+0.3799574853701528D-1
     &*t144*t469*t340+0.3799574853701528D-1*t144*t155*(t695-t701)
     &+0.3799574853701528D-1*t144*t329*t473+0.1923661050931536D1*t180
     &*t1166*t161+0.3799574853701528D-1*t144*t1166*t163-t753
     &-0.1124999956683108D1*t755-0.7694644203726145D1*t757
     &+0.1923661050931536D1*t763-t768-0.1124999956683108D1*t952
     &+0.1923661050931536D1*t955+0.7694644203726145D1*t973
     &-0.7694644203726145D1*t975-0.8740794299481065D-3*t982
     &-0.8740794299481065D-3*t985
      t1185 = t826+t828-t833-t834+t472+t476+t835+t479-t830+t332+t343
     &+t366+t114*(t1142+t1182)
      t1195 = t211*sigmabb*t398
      v2rhoab(i) = t1185*t205+t380*t498+t490*t392+t190*(
     &-0.802206976D-3*t212*t202*sigmabb*t398+0.17436143616D-4*t917
     &*sigmaaa*t1195-0.7573741056D-7*t924*sigmaaa*t1195)
      t1207 = sigmaaa*t217
      t1210 = t16*t224
      t1216 = t221/t7/t222/t209
      v2rhoasigmaaa(i) = -0.12407009817988D1*t4*t509-0.9305257363491D0
     &*t5*(-0.6120586666666667D-2*t211*t13-0.3935936D-4*t1207*t23
     &+0.9322052266666667D-6*t1210*t227-0.27073536D-8*t1216*t881)
     &-0.3109D-1*t233*t518+0.1321010150222857D-2*t237*t519+0.1D1*t242
     &*t260*t518-0.3109D-1*t33*t45*(-0.1448965333333333D1*t211*t48
     &+0.2094352D1*t1207*t52-0.7284036266666667D0*t1210*t269
     &+0.73498368D-1*t1216*t906)+t380*t528+t190*(-0.6308416D-2*t211
     &*t197+0.300827616D-3*t1207*t202-0.6538553856D-5*t917*t1207
     &+0.563804736D-3*t384*t211+0.2840152896D-7*t924*t1207
     &-0.315572544D-5*t389*t211)
      v2rhoasigmaab(i) = 0.D0
      t1260 = t212*t64
      v2rhoasigmabb(i) = t380*t558+t190*(0.300827616D-3*t212*t202*t64
     &-0.6538553856D-5*t917*t1260+0.2840152896D-7*t924*t1260)
      t1268 = t202*t9
      t1271 = t399*t9
      v2rhobsigmaaa(i) = t490*t528+t190*(0.300827616D-3*t399*t1268
     &-0.6538553856D-5*t917*t1271+0.2840152896D-7*t924*t1271)
      v2rhobsigmaab(i) = 0.D0
      t1282 = sigmabb*t404
      t1285 = t71*t411
      t1291 = t408/t62/t409/t396
      v2rhobsigmabb(i) = -0.12407009817988D1*t59*t539
     &-0.9305257363491D0*t60*(-0.6120586666666667D-2*t398*t68
     &-0.3935936D-4*t1282*t78+0.9322052266666667D-6*t1285*t414
     &-0.27073536D-8*t1291*t1073)-0.3109D-1*t420*t548
     &+0.1321010150222857D-2*t424*t549+0.1D1*t429*t447*t548-0.3109D-1
     &*t88*t100*(-0.1448965333333333D1*t398*t103+0.2094352D1*t1282
     &*t107-0.7284036266666667D0*t1285*t456+0.73498368D-1*t1291*t1102)
     &+t490*t558+t190*(-0.6308416D-2*t398*t197+0.300827616D-3*t1282
     &*t202-0.6538553856D-5*t917*t1282+0.563804736D-3*t384*t398
     &+0.2840152896D-7*t924*t1282-0.315572544D-5*t389*t398)
      t1333 = sigmaaa*t505
      t1338 = t16/t7/t870
      v2sigmaaa2(i) = -0.9305257363491D0*t5*(0.278944D-5*t20*t23
     &-0.26497216D-6*t1333*t227+0.10152576D-8*t1338*t881)-0.3109D-1
     &*t33*t45*(-0.4470272D0*t20*t52+0.22721488D0*t1333*t269
     &-0.27561888D-1*t1338*t906)+t190*(-0.112810356D-3*t20*t202
     &+0.2451957696D-5*t917*t20-0.1065057336D-7*t924*t20)
      v2sigmaaaab(i) = 0.D0
      t1364 = t9*t64
      v2sigmaaabb(i) = t190*(-0.112810356D-3*t1268*t64+0.2451957696D-5
     &*t917*t1364-0.1065057336D-7*t924*t1364)
      v2sigmaab2(i) = 0.D0
      v2sigmaabbb(i) = 0.D0
      t1372 = sigmabb*t535
      t1377 = t71/t62/t1062
      v2sigmabb2(i) = -0.9305257363491D0*t60*(0.278944D-5*t75*t78
     &-0.26497216D-6*t1372*t414+0.10152576D-8*t1377*t1073)-0.3109D-1
     &*t88*t100*(-0.4470272D0*t75*t107+0.22721488D0*t1372*t456
     &-0.27561888D-1*t1377*t1102)+t190*(-0.112810356D-3*t75*t202
     &+0.2451957696D-5*t917*t75-0.1065057336D-7*t924*t75)
      endif ! rhoa,rhob
      else ! rho
      zk(i) = 0.0d0
      vrhoa(i) = 0.0d0
      vrhob(i) = 0.0d0
      v2rhoa2(i) = 0.0d0
      v2rhob2(i) = 0.0d0
      v2rhoab(i) = 0.0d0
      vsigmaaa(i) = 0.0d0
      vsigmaab(i) = 0.0d0
      vsigmabb(i) = 0.0d0
      v2rhoasigmaaa(i) = 0.0d0
      v2rhoasigmaab(i) = 0.0d0
      v2rhoasigmabb(i) = 0.0d0
      v2rhobsigmaaa(i) = 0.0d0
      v2rhobsigmaab(i) = 0.0d0
      v2rhobsigmabb(i) = 0.0d0
      v2sigmaaa2(i) = 0.0d0
      v2sigmaab2(i) = 0.0d0
      v2sigmabb2(i) = 0.0d0
      v2sigmaaaab(i) = 0.0d0
      v2sigmaaabb(i) = 0.0d0
      v2sigmaabbb(i) = 0.0d0
      endif ! rho
      enddo
      
      endif ! ideriv
      return
      end
      
      
      subroutine rks_xc_b97_1
     & (ideriv,npt,rhoa1,sigmaaa1,
     &  zk,vrhoa,vsigmaaa,
     &  v2rhoa2,v2rhoasigmaaa,v2sigmaaa2)
c
c     F.A. Hamprecht, A.J. Cohen, D.J. Tozer, and N.C. Handy
c     Development and assessment of new exchange-correlation functionals
c     J. Chem. Phys. 109 (1998) 6264-6271
c
c
c     CITATION:
c
c     Functionals were obtained from the Density Functional Repository 
c     as developed and distributed by the Quantum Chemistry Group, 
c     CCLRC Daresbury Laboratory, Daresbury, Cheshire, WA4 4AD 
c     United Kingdom. Contact Huub van Dam (h.j.j.vandam@dl.ac.uk) or 
c     Paul Sherwood for further information.
c
c     COPYRIGHT:
c
c     Users may incorporate the source code into software packages and
c     redistribute the source code provided the source code is not
c     changed in anyway and is properly cited in any documentation or
c     publication related to its use.
c
c     ACKNOWLEDGEMENT:
c
c     The source code was generated using Maple 8 through a modified
c     version of the dfauto script published in:
c
c        R. Strange, F.R. Manby, P.J. Knowles
c        Automatic code generation in density functional theory
c        Comp. Phys. Comm. 136 (2001) 310-318.
c
      implicit real*8 (a-h,o-z)
      integer ideriv,npt
      real*8 rhoa1(npt)
      real*8 sigmaaa1(npt)
      real*8 zk(npt),vrhoa(npt),vsigmaaa(npt)
      real*8 v2rhoa2(npt),v2rhoasigmaaa(npt),v2sigmaaa2(npt)
      parameter(tol=1.0d-20)
      
      if(ideriv.eq.0) then
      
      do i=1,npt
      rho = dmax1(0.D0,rhoa1(i))
      if(rho.gt.tol) then
      sigma = dmax1(0.D0,sigmaaa1(i))
      t2 = rho**(1.D0/3.D0)
      t4 = rho**2
      t5 = t2**2
      t8 = sigma/t5/t4
      t10 = 1.D0+0.6349604207872798D-2*t8
      t14 = sigma**2
      t15 = t4**2
      t19 = t14/t2/t15/rho
      t20 = t10**2
      t27 = 1/rho
      t28 = t27**(1.D0/3.D0)
      t31 = rho*(1.D0+0.1606016560364007D0*t28)
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t43 = dlog(1.D0+0.321646831778707D2/(0.1248219874679732D2*t32
     &+0.4844076716063854D1*t28+0.2326004811900819D1*t35
     &+0.3819082618690966D0*t37))
      t45 = 1.D0+0.3174802103936399D0*t8
      t49 = t45**2
      t68 = dlog(1.D0+0.160818243221511D2/(0.598255043577108D1*t32
     &+0.2225569421150687D1*t28+0.8004286349993634D0*t35
     &+0.1897004325747559D0*t37))
      t75 = 1.D0+0.9524406311809197D-2*t8
      t79 = t75**2
      zk(i) = -0.7385587663820224D0*t2*rho*(0.789518D0
     &+0.3643434642498451D-2*t8/t10+0.2664884211053644D-4*t19/t20)
     &-0.3109D-1*t31*t43*(0.820011D-1+0.8625334103995448D0*t8/t45
     &-0.2893816905503742D0*t19/t49)+(-0.62182D-1*rho*(1.D0
     &+0.1325688999052018D0*t28)*t68+0.3109D-1*t31*t43)*(0.955689D0
     &+0.7510489645989766D-2*t8/t75-0.4969956136930951D-3*t19/t79)
      else ! rho
      zk(i) = 0.0d0
      endif ! rho
      enddo
      
      else if(ideriv.eq.1) then
      
      do i=1,npt
      rho = dmax1(0.D0,rhoa1(i))
      if(rho.gt.tol) then
      sigma = dmax1(0.D0,sigmaaa1(i))
      t2 = rho**(1.D0/3.D0)
      t3 = t2*rho
      t4 = rho**2
      t5 = t2**2
      t7 = 1/t5/t4
      t8 = sigma*t7
      t10 = 1.D0+0.6349604207872798D-2*t8
      t11 = 1/t10
      t14 = sigma**2
      t15 = t4**2
      t18 = 1/t2/t15/rho
      t19 = t14*t18
      t20 = t10**2
      t21 = 1/t20
      t24 = 0.789518D0+0.3643434642498451D-2*t8*t11
     &+0.2664884211053644D-4*t19*t21
      t27 = 1/rho
      t28 = t27**(1.D0/3.D0)
      t30 = 1.D0+0.1606016560364007D0*t28
      t31 = rho*t30
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t39 = 0.1248219874679732D2*t32+0.4844076716063854D1*t28
     &+0.2326004811900819D1*t35+0.3819082618690966D0*t37
      t42 = 1.D0+0.321646831778707D2/t39
      t43 = dlog(t42)
      t45 = 1.D0+0.3174802103936399D0*t8
      t46 = 1/t45
      t49 = t45**2
      t50 = 1/t49
      t53 = 0.820011D-1+0.8625334103995448D0*t8*t46
     &-0.2893816905503742D0*t19*t50
      t54 = t43*t53
      t58 = 1.D0+0.1325688999052018D0*t28
      t64 = 0.598255043577108D1*t32+0.2225569421150687D1*t28
     &+0.8004286349993634D0*t35+0.1897004325747559D0*t37
      t67 = 1.D0+0.160818243221511D2/t64
      t68 = dlog(t67)
      t73 = -0.62182D-1*rho*t58*t68+0.3109D-1*t31*t43
      t75 = 1.D0+0.9524406311809197D-2*t8
      t76 = 1/t75
      t79 = t75**2
      t80 = 1/t79
      t83 = 0.955689D0+0.7510489645989766D-2*t8*t76
     &-0.4969956136930951D-3*t19*t80
      zk(i) = -0.7385587663820224D0*t3*t24-0.3109D-1*t31*t54+t73*t83
      t90 = sigma/t5/t4/rho
      t96 = t14/t2/t15/t4
      t100 = t15**2
      t103 = t14*sigma/t100/rho
      t105 = 1/t20/t10
      t111 = t30*t43
      t114 = 1/t37
      t115 = t27*t114
      t118 = t39**2
      t119 = 1/t118
      t121 = t32**2
      t122 = t121**2
      t125 = 1/t4
      t126 = 1/t122/t32*t125
      t128 = t114*t125
      t131 = 1/t35*t125
      t134 = 1/t28*t125
      t136 = -0.4160732915599108D1*t126-0.3229384477375903D1*t128
     &-0.2326004811900819D1*t131-0.5092110158254621D0*t134
      t137 = 1/t42
      t147 = 1/t49/t45
      t158 = t64**2
      t186 = 1/t79/t75
      vrhoa(i) = -0.9847450218426965D0*t2*t24-0.3692793831910112D0*t3*
     &(-0.194316514266584D-1*t90*t11-0.1608710201810944D-3*t96*t21
     &+0.18049024D-5*t103*t105)-0.3109D-1*t111*t53
     &+0.1664368495390566D-2*t115*t54+0.5D0*t31*t119*t136*t137*t53
     &-0.15545D-1*t31*t43*(-0.4600178188797572D1*t90*t46
     &+0.4547203571765012D1*t96*t50-0.97997824D0*t103*t147)+(
     &-0.62182D-1*t58*t68+rho*(0.2747799777968419D-2*t128*t68+0.1D1
     &*t58/t158*(-0.99709173929518D0*t126-0.7418564737168958D0*t128
     &-0.4002143174996817D0*t131-0.1264669550498372D0*t134)/t67)
     &+0.3109D-1*t111-0.1664368495390566D-2*t115*t43-0.5D0*t31*t119
     &*t136*t137)*t83+t73*(-0.2002797238930604D-1*t90*t76
     &+0.2841397819667287D-2*t96*t80-0.2524580352D-4*t103*t186)
      t193 = sigma*t18
      t197 = t14/t100
      vsigmaaa(i) = -0.7385587663820224D0*t3*(0.145737385699938D-1*t7
     &*t11+0.1206532651358208D-3*t193*t21-0.13536768D-5*t197*t105)
     &-0.3109D-1*t31*t43*(0.3450133641598179D1*t7*t46
     &-0.3410402678823759D1*t193*t50+0.73498368D0*t197*t147)+2.D0*t73*
     &(0.1502097929197953D-1*t7*t76-0.2131048364750465D-2*t193*t80
     &+0.1893435264D-4*t197*t186)
      else ! rho
      zk(i) = 0.0d0
      vrhoa(i) = 0.0d0
      vsigmaaa(i) = 0.0d0
      endif ! rho
      enddo
      
      else if(ideriv.eq.2) then
      
      do i=1,npt
      rho = dmax1(0.D0,rhoa1(i))
      if(rho.gt.tol) then
      sigma = dmax1(0.D0,sigmaaa1(i))
      t2 = rho**(1.D0/3.D0)
      t3 = t2*rho
      t4 = rho**2
      t5 = t2**2
      t7 = 1/t5/t4
      t8 = sigma*t7
      t10 = 1.D0+0.6349604207872798D-2*t8
      t11 = 1/t10
      t14 = sigma**2
      t15 = t4**2
      t18 = 1/t2/t15/rho
      t19 = t14*t18
      t20 = t10**2
      t21 = 1/t20
      t24 = 0.789518D0+0.3643434642498451D-2*t8*t11
     &+0.2664884211053644D-4*t19*t21
      t27 = 1/rho
      t28 = t27**(1.D0/3.D0)
      t30 = 1.D0+0.1606016560364007D0*t28
      t31 = rho*t30
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t39 = 0.1248219874679732D2*t32+0.4844076716063854D1*t28
     &+0.2326004811900819D1*t35+0.3819082618690966D0*t37
      t42 = 1.D0+0.321646831778707D2/t39
      t43 = dlog(t42)
      t45 = 1.D0+0.3174802103936399D0*t8
      t46 = 1/t45
      t49 = t45**2
      t50 = 1/t49
      t53 = 0.820011D-1+0.8625334103995448D0*t8*t46
     &-0.2893816905503742D0*t19*t50
      t54 = t43*t53
      t58 = 1.D0+0.1325688999052018D0*t28
      t64 = 0.598255043577108D1*t32+0.2225569421150687D1*t28
     &+0.8004286349993634D0*t35+0.1897004325747559D0*t37
      t67 = 1.D0+0.160818243221511D2/t64
      t68 = dlog(t67)
      t73 = -0.62182D-1*rho*t58*t68+0.3109D-1*t31*t43
      t75 = 1.D0+0.9524406311809197D-2*t8
      t76 = 1/t75
      t79 = t75**2
      t80 = 1/t79
      t83 = 0.955689D0+0.7510489645989766D-2*t8*t76
     &-0.4969956136930951D-3*t19*t80
      zk(i) = -0.7385587663820224D0*t3*t24-0.3109D-1*t31*t54+t73*t83
      t87 = t4*rho
      t89 = 1/t5/t87
      t90 = sigma*t89
      t95 = 1/t2/t15/t4
      t96 = t14*t95
      t99 = t14*sigma
      t100 = t15**2
      t102 = 1/t100/rho
      t103 = t99*t102
      t105 = 1/t20/t10
      t108 = -0.194316514266584D-1*t90*t11-0.1608710201810944D-3*t96
     &*t21+0.18049024D-5*t103*t105
      t111 = t30*t43
      t114 = 1/t37
      t115 = t27*t114
      t118 = t39**2
      t119 = 1/t118
      t120 = t31*t119
      t121 = t32**2
      t122 = t121**2
      t123 = t122*t32
      t124 = 1/t123
      t125 = 1/t4
      t126 = t124*t125
      t128 = t114*t125
      t130 = 1/t35
      t131 = t130*t125
      t133 = 1/t28
      t134 = t133*t125
      t136 = -0.4160732915599108D1*t126-0.3229384477375903D1*t128
     &-0.2326004811900819D1*t131-0.5092110158254621D0*t134
      t137 = 1/t42
      t138 = t136*t137
      t139 = t138*t53
      t147 = 1/t49/t45
      t150 = -0.4600178188797572D1*t90*t46+0.4547203571765012D1*t96
     &*t50-0.97997824D0*t103*t147
      t151 = t43*t150
      t156 = t128*t68
      t158 = t64**2
      t159 = 1/t158
      t160 = t58*t159
      t165 = -0.99709173929518D0*t126-0.7418564737168958D0*t128
     &-0.4002143174996817D0*t131-0.1264669550498372D0*t134
      t166 = 1/t67
      t168 = t160*t165*t166
      t176 = t119*t136*t137
      t179 = -0.62182D-1*t58*t68+rho*(0.2747799777968419D-2*t156+0.1D1
     &*t168)+0.3109D-1*t111-0.1664368495390566D-2*t115*t43-0.5D0*t31
     &*t176
      t186 = 1/t79/t75
      t189 = -0.2002797238930604D-1*t90*t76+0.2841397819667287D-2*t96
     &*t80-0.2524580352D-4*t103*t186
      vrhoa(i) = -0.9847450218426965D0*t2*t24-0.3692793831910112D0*t3
     &*t108-0.3109D-1*t111*t53+0.1664368495390566D-2*t115*t54+0.5D0
     &*t120*t139-0.15545D-1*t31*t151+t179*t83+t73*t189
      t193 = sigma*t18
      t196 = 1/t100
      t197 = t14*t196
      t200 = 0.145737385699938D-1*t7*t11+0.1206532651358208D-3*t193
     &*t21-0.13536768D-5*t197*t105
      t209 = 0.3450133641598179D1*t7*t46-0.3410402678823759D1*t193*t50
     &+0.73498368D0*t197*t147
      t210 = t43*t209
      t219 = 0.1502097929197953D-1*t7*t76-0.2131048364750465D-2*t193
     &*t80+0.1893435264D-4*t197*t186
      vsigmaaa(i) = -0.7385587663820224D0*t3*t200-0.3109D-1*t31*t210
     &+2.D0*t73*t219
      t224 = 1/t15
      t225 = 1/t123/t27*t224
      t227 = 1/t87
      t228 = t124*t227
      t231 = 1/t37/t27
      t232 = t231*t224
      t234 = t114*t227
      t238 = 1/t35/t27*t224
      t240 = t130*t227
      t244 = 1/t28/t27*t224
      t246 = t133*t227
      t248 = -0.6934554859331846D1*t225+0.1664293166239643D2*t228
     &-0.4305845969834537D1*t232+0.1291753790950361D2*t234
     &-0.2326004811900819D1*t238+0.9304019247603276D1*t240
     &-0.3394740105503081D0*t244+0.2036844063301848D1*t246
      t254 = 1/t118/t39
      t256 = t136**2
      t264 = t227*t231
      t269 = t30*t119
      t276 = sigma/t5/t15
      t282 = t14/t2/t15/t87
      t285 = t100*t4
      t287 = t99/t285
      t290 = t14**2
      t294 = t290/t5/t100/t15
      t295 = t20**2
      t296 = 1/t295
      t307 = 0.2D1*t168
      t308 = 0.5495599555936838D-2*t156
      t310 = 0.1831866518645613D-2*t232*t68
      t312 = 0.5495599555936838D-2*t234*t68
      t324 = 0.1D1*t160*(-0.8309097827459833D0*t225
     &+0.199418347859036D1*t228-0.4945709824779306D0*t232
     &+0.1483712947433792D1*t234-0.2001071587498409D0*t238
     &+0.8004286349993634D0*t240-0.4215565168327908D-1*t244
     &+0.2529339100996745D0*t246)*t166
      t325 = t158**2
      t328 = t165**2
      t329 = t67**2
      t333 = 0.160818243221511D2*t58/t325*t328/t329
      t339 = 0.2D1*t58/t158/t64*t328*t166
      t343 = 0.8837926660346786D-1*t128*t159*t165*t166
      t354 = dlog(1.D0+0.2960857464321668D2/(0.8157414703487641D1*t32
     &+0.2247591863577616D1*t28+0.4300972471276643D0*t35
     &+0.1911512595127338D0*t37))
      t356 = (1.D0+0.6901399211255825D-1*t28)*t354*t125
      t374 = t118**2
      t375 = 1/t374
      t377 = t42**2
      t378 = 1/t377
      t395 = t49**2
      t396 = 1/t395
      t408 = t282*t80
      t410 = t287*t186
      t412 = t79**2
      t413 = 1/t412
      t415 = 0.1923610323140663D-5*t294*t413
      s1 = 0.5D0*t120*t248*t137*t53-0.1D1*t31*t254*t256*t137*t53
     &-0.1070677706909338D0*t115*t119*t139+0.2219157993854088D-2*t264
     &*t54+0.3328736990781132D-2*t115*t151+0.2D1*t269*t139-0.6218D-1
     &*t111*t150-0.3692793831910112D0*t3*(0.1424987771288283D0*t276
     &*t11+0.1379655345415848D-2*t282*t21-0.4338389447111111D-4*t287
     &*t105+0.1833666539814354D-6*t294*t296)-0.6564966812284644D0/t5*t24
      s2 = s1-0.1969490043685393D1*t2*t108+(t307+t308+rho*(t310-t312
     &+t324+t333-t339-t343+0.3377399869956914D-1*t356)-0.2D1*t269*t138
     &-0.5D0*t31*t119*t248*t137-0.2219157993854088D-2*t264*t43
     &+0.1070677706909338D0*t115*t176+0.1D1*t31*t254*t256*t137
     &-0.1608234158893535D2*t31*t375*t256*t378)*t83
     &+0.1608234158893535D2*t31*t375*t256*t378*t53-0.15545D-1*t31*t43*
     &(0.337346400511822D2*t276*t46-0.6538706145157114D2*t282*t50
     &+0.3303851121777778D2*t287*t147-0.4977979165062223D1*t294*t396)
      v2rhoa2(i) = s2+0.1D1*t120*t138*t150+t73*(0.1468717975215776D0
     &*t276*t76-0.2892265698770606D-1*t408+0.464114190336D-3*t410-t415
     &)+4.D0*t179*t189+(t308+t307+rho*(t310-t312+t324+t333-t339-t343
     &-0.3377399869956914D-1*t356))*t83+t73*(-0.8085739643479291D-2
     &*t408+0.278978297856D-3*t410-t415)
      t433 = sigma*t95
      t436 = t14*t102
      t442 = t99/t5/t100/t87
      t471 = t433*t80
      t473 = t436*t186
      t476 = 0.1442707742355497D-5*t442*t413
      v2rhoasigmaaa(i) = -0.9847450218426965D0*t2*t200
     &-0.3692793831910112D0*t3*(-0.7772660570663362D-1*t89*t11
     &-0.7934349787902444D-3*t433*t21+0.2983056725333333D-4*t436*t105
     &-0.1375249904860765D-6*t442*t296)-0.3109D-1*t111*t209
     &+0.1664368495390566D-2*t115*t210+0.5D0*t120*t138*t209-0.15545D-1
     &*t31*t43*(-0.1840071275519029D2*t89*t46+0.4221949073103084D2
     &*t433*t50-0.2330891605333333D2*t436*t147+0.3733484373796667D1
     &*t442*t396)+2.D0*t179*t219+t73*(-0.8011188955722417D-1*t89*t76
     &+0.1742989601127862D-1*t471-0.310216937472D-3*t473+t476)+t73*
     &(0.6064304732609468D-2*t471-0.209233723392D-3*t473+t476)
      t485 = sigma*t196
      t490 = t14/t5/t285
      v2sigmaaa2(i) = -0.7385587663820224D0*t3*(0.1124631735494002D-3
     &*t18*t21-0.1695821824D-4*t485*t105+0.1031437428645574D-6*t490
     &*t296)-0.3109D-1*t31*t43*(-0.1802300733297809D2*t18*t50
     &+0.1454175232D2*t485*t147-0.28001132803475D1*t490*t396)+4.D0*t73
     &*(-0.4548228549457101D-2*t18*t80+0.156925292544D-3*t485*t186
     &-0.1082030806766623D-5*t490*t413)
      else ! rho
      zk(i) = 0.0d0
      vrhoa(i) = 0.0d0
      v2rhoa2(i) = 0.0d0
      vsigmaaa(i) = 0.0d0
      v2rhoasigmaaa(i) = 0.0d0
      v2sigmaaa2(i) = 0.0d0
      endif ! rho
      enddo
      
      endif ! ideriv
      return
      end

c:XC_B97_1subrend
