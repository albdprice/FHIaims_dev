c:XC_B97_2subrstart

c    Generated: Thu Jun 19 11:34:14 GMT 2003

      subroutine uks_xc_b97_2
     & (ideriv,npt,rhoa1,rhob1,sigmaaa1,sigmabb1,sigmaab1,
     &  zk,vrhoa,vrhob,vsigmaaa,vsigmabb,vsigmaab,
     &  v2rhoa2,v2rhob2,v2rhoab,
     &  v2rhoasigmaaa,v2rhoasigmaab,v2rhoasigmabb,
     &  v2rhobsigmabb,v2rhobsigmaab,v2rhobsigmaaa,
     &  v2sigmaaa2,v2sigmaaaab,v2sigmaaabb,
     &  v2sigmaab2,v2sigmaabbb,v2sigmabb2)
c
c     P.J. Wilson, T.J. Bradley, and D.J. Tozer
c     Hybrid exchange-correlation functional determined from
c     thermochemical data and ab initio potentials
c     J. Chem. Phys. 115 (2001) 9233-9242
c
c
c     CITATION:
c
c     Functionals were obtained from the Density Functional Repository 
c     as developed and distributed by the Quantum Chemistry Group, 
c     CCLRC Daresbury Laboratory, Daresbury, Cheshire, WA4 4AD 
c     United Kingdom. Contact Huub van Dam (h.j.j.vandam@dl.ac.uk) or 
c     Paul Sherwood for further information.
c
c     COPYRIGHT:
c
c     Users may incorporate the source code into software packages and
c     redistribute the source code provided the source code is not
c     changed in anyway and is properly cited in any documentation or
c     publication related to its use.
c
c     ACKNOWLEDGEMENT:
c
c     The source code was generated using Maple 8 through a modified
c     version of the dfauto script published in:
c
c        R. Strange, F.R. Manby, P.J. Knowles
c        Automatic code generation in density functional theory
c        Comp. Phys. Comm. 136 (2001) 310-318.
c
      implicit real*8 (a-h,o-z)
      integer ideriv,npt
      real*8 rhoa1(npt),rhob1(npt)
      real*8 sigmaaa1(npt),sigmabb1(npt),sigmaab1(npt)
      real*8 zk(npt),vrhoa(npt),vrhob(npt)
      real*8 vsigmaaa(npt),vsigmabb(npt),vsigmaab(npt)
      real*8 v2rhoa2(npt),v2rhob2(npt),v2rhoab(npt)
      real*8 v2rhoasigmaaa(npt),v2rhoasigmaab(npt)
      real*8 v2rhoasigmabb(npt),v2rhobsigmabb(npt)
      real*8 v2rhobsigmaab(npt),v2rhobsigmaaa(npt)
      real*8 v2sigmaaa2(npt),v2sigmaaaab(npt),v2sigmaaabb(npt)
      real*8 v2sigmaab2(npt),v2sigmaabbb(npt),v2sigmabb2(npt)
      parameter(tol=1.0d-20)
      
      if (ideriv.eq.0) then
      
      do i=1,npt
      rhoa = dmax1(0.D0,rhoa1(i))
      rhob = dmax1(0.D0,rhob1(i))
      rho = rhoa+rhob
      if(rho.gt.tol) then
      if(rhoa.lt.tol) then
      rho = rhob
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmabb
      t2 = rhob**(1.D0/3.D0)
      t4 = rhob**2
      t5 = t2**2
      t8 = sigmabb/t5/t4
      t10 = 1.D0+0.4D-2*t8
      t14 = sigmabb**2
      t15 = t4**2
      t19 = t14/t2/t15/rhob
      t20 = t10**2
      t27 = 1/rhob
      t28 = t27**(1.D0/3.D0)
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t43 = dlog(1.D0+0.321646831778707D2/(0.1112037486309468D2*t32
     &+0.3844746237447211D1*t28+0.1644733775567609D1*t35
     &+0.2405871291288192D0*t37))
      t45 = 1.D0+0.2D0*t8
      t49 = t45**2
      zk(i) = -0.9305257363491D0*t2*rhob*(0.827642D0+0.19136D-3*t8/t10
     &+0.2818D-4*t19/t20)-0.3109D-1*rhob*(1.D0+0.1274696188700087D0
     &*t28)*t43*(0.585808D0-0.1383364D0*t8/t45+0.1579184D-1*t19/t49)
      elseif(rhob.lt.tol) then
      rho = rhoa
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigma = sigmaaa
      t2 = rhoa**(1.D0/3.D0)
      t4 = rhoa**2
      t5 = t2**2
      t8 = sigmaaa/t5/t4
      t10 = 1.D0+0.4D-2*t8
      t14 = sigmaaa**2
      t15 = t4**2
      t19 = t14/t2/t15/rhoa
      t20 = t10**2
      t27 = 1/rhoa
      t28 = t27**(1.D0/3.D0)
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t43 = dlog(1.D0+0.321646831778707D2/(0.1112037486309468D2*t32
     &+0.3844746237447211D1*t28+0.1644733775567609D1*t35
     &+0.2405871291288192D0*t37))
      t45 = 1.D0+0.2D0*t8
      t49 = t45**2
      zk(i) = -0.9305257363491D0*t2*rhoa*(0.827642D0+0.19136D-3*t8/t10
     &+0.2818D-4*t19/t20)-0.3109D-1*rhoa*(1.D0+0.1274696188700087D0
     &*t28)*t43*(0.585808D0-0.1383364D0*t8/t45+0.1579184D-1*t19/t49)
      else ! (.not.(rhoa.lt.tol).and..not.(rhob.lt.tol))
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigmaab = sigmaab1(i)
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmaaa+sigmabb+2.D0*sigmaab
      t4 = rhoa**(1.D0/3.D0)
      t6 = rhoa**2
      t7 = t4**2
      t10 = sigmaaa/t7/t6
      t12 = 1.D0+0.4D-2*t10
      t16 = sigmaaa**2
      t17 = t6**2
      t21 = t16/t4/t17/rhoa
      t22 = t12**2
      t29 = 1/rhoa
      t30 = t29**(1.D0/3.D0)
      t33 = rhoa*(1.D0+0.1274696188700087D0*t30)
      t34 = t29**(1.D0/6.D0)
      t37 = dsqrt(t29)
      t39 = t30**2
      t45 = dlog(1.D0+0.321646831778707D2/(0.1112037486309468D2*t34
     &+0.3844746237447211D1*t30+0.1644733775567609D1*t37
     &+0.2405871291288192D0*t39))
      t47 = 1.D0+0.2D0*t10
      t51 = t47**2
      t59 = rhob**(1.D0/3.D0)
      t61 = rhob**2
      t62 = t59**2
      t65 = sigmabb/t62/t61
      t67 = 1.D0+0.4D-2*t65
      t71 = sigmabb**2
      t72 = t61**2
      t76 = t71/t59/t72/rhob
      t77 = t67**2
      t84 = 1/rhob
      t85 = t84**(1.D0/3.D0)
      t88 = rhob*(1.D0+0.1274696188700087D0*t85)
      t89 = t84**(1.D0/6.D0)
      t92 = dsqrt(t84)
      t94 = t85**2
      t100 = dlog(1.D0+0.321646831778707D2/(0.1112037486309468D2*t89
     &+0.3844746237447211D1*t85+0.1644733775567609D1*t92
     &+0.2405871291288192D0*t94))
      t102 = 1.D0+0.2D0*t65
      t106 = t102**2
      t114 = rhoa+rhob
      t115 = 1/t114
      t116 = t115**(1.D0/3.D0)
      t119 = t115**(1.D0/6.D0)
      t122 = dsqrt(t115)
      t124 = t116**2
      t130 = dlog(1.D0+0.160818243221511D2/(0.598255043577108D1*t119
     &+0.2225569421150687D1*t116+0.8004286349993634D0*t122
     &+0.1897004325747559D0*t124))
      t132 = 0.62182D-1*(1.D0+0.1325688999052018D0*t116)*t130
      t143 = dlog(1.D0+0.2960857464321668D2/(0.8157414703487641D1*t119
     &+0.2247591863577616D1*t116+0.4300972471276643D0*t122
     &+0.1911512595127338D0*t124))
      t146 = rhoa-1.D0*rhob
      t147 = t146*t115
      t148 = 1.D0+t147
      t149 = t148**(1.D0/3.D0)
      t152 = 1.D0-1.D0*t147
      t153 = t152**(1.D0/3.D0)
      t155 = t149*t148+t153*t152-2.D0
      t156 = t146**2
      t157 = t156**2
      t158 = t114**2
      t159 = t158**2
      t161 = t157/t159
      t177 = dlog(1.D0+0.321646831778707D2/(0.1112037486309468D2*t119
     &+0.3844746237447211D1*t116+0.1644733775567609D1*t122
     &+0.2405871291288192D0*t124))
      t193 = 0.5D0*t10+0.5D0*t65
      t196 = 1.D0+0.3D-2*t10+0.3D-2*t65
      t200 = t193**2
      t201 = t196**2
      zk(i) = -0.9305257363491D0*t4*rhoa*(0.827642D0+0.19136D-3*t10
     &/t12+0.2818D-4*t21/t22)-0.3109D-1*t33*t45*(0.585808D0
     &-0.1383364D0*t10/t47+0.1579184D-1*t21/t51)-0.9305257363491D0*t59
     &*rhob*(0.827642D0+0.19136D-3*t65/t67+0.2818D-4*t76/t77)
     &-0.3109D-1*t88*t100*(0.585808D0-0.1383364D0*t65/t102
     &+0.1579184D-1*t76/t106)+(t114*(-t132+0.3799574853701528D-1*(1.D0
     &+0.6901399211255825D-1*t116)*t143*t155*(1.D0-1.D0*t161)
     &+0.1923661050931536D1*(-0.3109D-1*(1.D0+0.1274696188700087D0
     &*t116)*t177+t132)*t155*t161)+0.3109D-1*t33*t45+0.3109D-1*t88
     &*t100)*(0.999849D0+0.843756D-2*t193/t196-0.2678616D-3*t200/t201)
      endif ! rhoa,rhob
      else ! rho
      zk(i) = 0.0d0
      endif ! rho
      enddo
      
      else if(ideriv.eq.1) then
      
      do i=1,npt
      rhoa = dmax1(0.D0,rhoa1(i))
      rhob = dmax1(0.D0,rhob1(i))
      rho = rhoa+rhob
      if(rho.gt.tol) then
      if(rhoa.lt.tol) then
      rho = rhob
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmabb
      t2 = rhob**(1.D0/3.D0)
      t3 = t2*rhob
      t4 = rhob**2
      t5 = t2**2
      t7 = 1/t5/t4
      t8 = sigmabb*t7
      t10 = 1.D0+0.4D-2*t8
      t11 = 1/t10
      t14 = sigmabb**2
      t15 = t4**2
      t18 = 1/t2/t15/rhob
      t19 = t14*t18
      t20 = t10**2
      t21 = 1/t20
      t24 = 0.827642D0+0.19136D-3*t8*t11+0.2818D-4*t19*t21
      t27 = 1/rhob
      t28 = t27**(1.D0/3.D0)
      t30 = 1.D0+0.1274696188700087D0*t28
      t31 = rhob*t30
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t39 = 0.1112037486309468D2*t32+0.3844746237447211D1*t28
     &+0.1644733775567609D1*t35+0.2405871291288192D0*t37
      t42 = 1.D0+0.321646831778707D2/t39
      t43 = dlog(t42)
      t45 = 1.D0+0.2D0*t8
      t46 = 1/t45
      t49 = t45**2
      t50 = 1/t49
      t53 = 0.585808D0-0.1383364D0*t8*t46+0.1579184D-1*t19*t50
      t54 = t43*t53
      zk(i) = -0.9305257363491D0*t3*t24-0.3109D-1*t31*t54
      vrhoa(i) = 0.D0
      t62 = sigmabb/t5/t4/rhob
      t68 = t14/t2/t15/t4
      t72 = t15**2
      t75 = t14*sigmabb/t72/rhob
      t77 = 1/t20/t10
      t86 = 1/t37
      t90 = t39**2
      t93 = t32**2
      t94 = t93**2
      t97 = 1/t4
      t119 = 1/t49/t45
      vrhob(i) = -0.12407009817988D1*t2*t24-0.9305257363491D0*t3*(
     &-0.5102933333333333D-3*t62*t11-0.14825216D-3*t68*t21
     &+0.6011733333333333D-6*t75*t77)-0.3109D-1*t30*t43*t53
     &+0.1321010150222857D-2*t27*t86*t54+0.1D1*t31/t90*(
     &-0.1853395810515781D1/t94/t32*t97-0.128158207914907D1*t86*t97
     &-0.8223668877838045D0/t35*t97-0.1603914194192128D0/t28*t97)/t42
     &*t53-0.3109D-1*t31*t43*(0.3688970666666667D0*t62*t46
     &-0.15800256D0*t68*t50+0.1684462933333333D-1*t75*t119)
      vsigmaaa(i) = 0.D0
      vsigmaab(i) = 0.D0
      t128 = sigmabb*t18
      t132 = t14/t72
      vsigmabb(i) = -0.9305257363491D0*t3*(0.19136D-3*t7*t11
     &+0.5559456D-4*t128*t21-0.22544D-6*t132*t77)-0.3109D-1*t31*t43*(
     &-0.1383364D0*t7*t46+0.5925096D-1*t128*t50-0.6316736D-2*t132*t119)
      elseif(rhob.lt.tol) then
      rho = rhoa
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigma = sigmaaa
      t2 = rhoa**(1.D0/3.D0)
      t3 = t2*rhoa
      t4 = rhoa**2
      t5 = t2**2
      t7 = 1/t5/t4
      t8 = sigmaaa*t7
      t10 = 1.D0+0.4D-2*t8
      t11 = 1/t10
      t14 = sigmaaa**2
      t15 = t4**2
      t18 = 1/t2/t15/rhoa
      t19 = t14*t18
      t20 = t10**2
      t21 = 1/t20
      t24 = 0.827642D0+0.19136D-3*t8*t11+0.2818D-4*t19*t21
      t27 = 1/rhoa
      t28 = t27**(1.D0/3.D0)
      t30 = 1.D0+0.1274696188700087D0*t28
      t31 = rhoa*t30
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t39 = 0.1112037486309468D2*t32+0.3844746237447211D1*t28
     &+0.1644733775567609D1*t35+0.2405871291288192D0*t37
      t42 = 1.D0+0.321646831778707D2/t39
      t43 = dlog(t42)
      t45 = 1.D0+0.2D0*t8
      t46 = 1/t45
      t49 = t45**2
      t50 = 1/t49
      t53 = 0.585808D0-0.1383364D0*t8*t46+0.1579184D-1*t19*t50
      t54 = t43*t53
      zk(i) = -0.9305257363491D0*t3*t24-0.3109D-1*t31*t54
      t62 = sigmaaa/t5/t4/rhoa
      t68 = t14/t2/t15/t4
      t72 = t15**2
      t75 = t14*sigmaaa/t72/rhoa
      t77 = 1/t20/t10
      t86 = 1/t37
      t90 = t39**2
      t93 = t32**2
      t94 = t93**2
      t97 = 1/t4
      t119 = 1/t49/t45
      vrhoa(i) = -0.12407009817988D1*t2*t24-0.9305257363491D0*t3*(
     &-0.5102933333333333D-3*t62*t11-0.14825216D-3*t68*t21
     &+0.6011733333333333D-6*t75*t77)-0.3109D-1*t30*t43*t53
     &+0.1321010150222857D-2*t27*t86*t54+0.1D1*t31/t90*(
     &-0.1853395810515781D1/t94/t32*t97-0.128158207914907D1*t86*t97
     &-0.8223668877838045D0/t35*t97-0.1603914194192128D0/t28*t97)/t42
     &*t53-0.3109D-1*t31*t43*(0.3688970666666667D0*t62*t46
     &-0.15800256D0*t68*t50+0.1684462933333333D-1*t75*t119)
      vrhob(i) = 0.D0
      t128 = sigmaaa*t18
      t132 = t14/t72
      vsigmaaa(i) = -0.9305257363491D0*t3*(0.19136D-3*t7*t11
     &+0.5559456D-4*t128*t21-0.22544D-6*t132*t77)-0.3109D-1*t31*t43*(
     &-0.1383364D0*t7*t46+0.5925096D-1*t128*t50-0.6316736D-2*t132*t119)
      vsigmaab(i) = 0.D0
      vsigmabb(i) = 0.D0
      else ! (.not.(rhoa.lt.tol).and..not.(rhob.lt.tol))
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigmaab = sigmaab1(i)
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmaaa+sigmabb+2.D0*sigmaab
      t4 = rhoa**(1.D0/3.D0)
      t5 = t4*rhoa
      t6 = rhoa**2
      t7 = t4**2
      t9 = 1/t7/t6
      t10 = sigmaaa*t9
      t12 = 1.D0+0.4D-2*t10
      t13 = 1/t12
      t16 = sigmaaa**2
      t17 = t6**2
      t20 = 1/t4/t17/rhoa
      t21 = t16*t20
      t22 = t12**2
      t23 = 1/t22
      t26 = 0.827642D0+0.19136D-3*t10*t13+0.2818D-4*t21*t23
      t29 = 1/rhoa
      t30 = t29**(1.D0/3.D0)
      t32 = 1.D0+0.1274696188700087D0*t30
      t33 = rhoa*t32
      t34 = t29**(1.D0/6.D0)
      t37 = dsqrt(t29)
      t39 = t30**2
      t41 = 0.1112037486309468D2*t34+0.3844746237447211D1*t30
     &+0.1644733775567609D1*t37+0.2405871291288192D0*t39
      t44 = 1.D0+0.321646831778707D2/t41
      t45 = dlog(t44)
      t47 = 1.D0+0.2D0*t10
      t48 = 1/t47
      t51 = t47**2
      t52 = 1/t51
      t55 = 0.585808D0-0.1383364D0*t10*t48+0.1579184D-1*t21*t52
      t56 = t45*t55
      t59 = rhob**(1.D0/3.D0)
      t60 = t59*rhob
      t61 = rhob**2
      t62 = t59**2
      t64 = 1/t62/t61
      t65 = sigmabb*t64
      t67 = 1.D0+0.4D-2*t65
      t68 = 1/t67
      t71 = sigmabb**2
      t72 = t61**2
      t75 = 1/t59/t72/rhob
      t76 = t71*t75
      t77 = t67**2
      t78 = 1/t77
      t81 = 0.827642D0+0.19136D-3*t65*t68+0.2818D-4*t76*t78
      t84 = 1/rhob
      t85 = t84**(1.D0/3.D0)
      t87 = 1.D0+0.1274696188700087D0*t85
      t88 = rhob*t87
      t89 = t84**(1.D0/6.D0)
      t92 = dsqrt(t84)
      t94 = t85**2
      t96 = 0.1112037486309468D2*t89+0.3844746237447211D1*t85
     &+0.1644733775567609D1*t92+0.2405871291288192D0*t94
      t99 = 1.D0+0.321646831778707D2/t96
      t100 = dlog(t99)
      t102 = 1.D0+0.2D0*t65
      t103 = 1/t102
      t106 = t102**2
      t107 = 1/t106
      t110 = 0.585808D0-0.1383364D0*t65*t103+0.1579184D-1*t76*t107
      t111 = t100*t110
      t114 = rhoa+rhob
      t115 = 1/t114
      t116 = t115**(1.D0/3.D0)
      t118 = 1.D0+0.1325688999052018D0*t116
      t119 = t115**(1.D0/6.D0)
      t122 = dsqrt(t115)
      t124 = t116**2
      t126 = 0.598255043577108D1*t119+0.2225569421150687D1*t116
     &+0.8004286349993634D0*t122+0.1897004325747559D0*t124
      t129 = 1.D0+0.160818243221511D2/t126
      t130 = dlog(t129)
      t132 = 0.62182D-1*t118*t130
      t134 = 1.D0+0.6901399211255825D-1*t116
      t139 = 0.8157414703487641D1*t119+0.2247591863577616D1*t116
     &+0.4300972471276643D0*t122+0.1911512595127338D0*t124
      t142 = 1.D0+0.2960857464321668D2/t139
      t143 = dlog(t142)
      t144 = t134*t143
      t146 = rhoa-1.D0*rhob
      t147 = t146*t115
      t148 = 1.D0+t147
      t149 = t148**(1.D0/3.D0)
      t152 = 1.D0-1.D0*t147
      t153 = t152**(1.D0/3.D0)
      t155 = t149*t148+t153*t152-2.D0
      t156 = t146**2
      t157 = t156**2
      t158 = t114**2
      t159 = t158**2
      t160 = 1/t159
      t161 = t157*t160
      t163 = 1.D0-1.D0*t161
      t166 = 0.3799574853701528D-1*t144*t155*t163
      t168 = 1.D0+0.1274696188700087D0*t116
      t173 = 0.1112037486309468D2*t119+0.3844746237447211D1*t116
     &+0.1644733775567609D1*t122+0.2405871291288192D0*t124
      t176 = 1.D0+0.321646831778707D2/t173
      t177 = dlog(t176)
      t180 = -0.3109D-1*t168*t177+t132
      t181 = t180*t155
      t183 = 0.1923661050931536D1*t181*t161
      t190 = t114*(-t132+t166+t183)+0.3109D-1*t33*t45+0.3109D-1*t88*t100
      t193 = 0.5D0*t10+0.5D0*t65
      t196 = 1.D0+0.3D-2*t10+0.3D-2*t65
      t197 = 1/t196
      t200 = t193**2
      t201 = t196**2
      t202 = 1/t201
      t205 = 0.999849D0+0.843756D-2*t193*t197-0.2678616D-3*t200*t202
      zk(i) = -0.9305257363491D0*t5*t26-0.3109D-1*t33*t56
     &-0.9305257363491D0*t60*t81-0.3109D-1*t88*t111+t190*t205
      t212 = sigmaaa/t7/t6/rhoa
      t218 = t16/t4/t17/t6
      t222 = t17**2
      t225 = t16*sigmaaa/t222/rhoa
      t227 = 1/t22/t12
      t233 = t32*t45
      t236 = 1/t39
      t237 = t29*t236
      t240 = t41**2
      t241 = 1/t240
      t243 = t34**2
      t244 = t243**2
      t247 = 1/t6
      t258 = -0.1853395810515781D1/t244/t34*t247-0.128158207914907D1
     &*t236*t247-0.8223668877838045D0/t37*t247-0.1603914194192128D0
     &/t30*t247
      t259 = 1/t44
      t269 = 1/t51/t47
      t277 = 1/t158
      t278 = 1/t124*t277
      t279 = t278*t130
      t280 = 0.2747799777968419D-2*t279
      t281 = t126**2
      t284 = t119**2
      t285 = t284**2
      t288 = 1/t285/t119*t277
      t292 = 1/t122*t277
      t295 = 1/t116*t277
      t300 = t118/t281*(-0.99709173929518D0*t288-0.7418564737168958D0
     &*t278-0.4002143174996817D0*t292-0.1264669550498372D0*t295)/t129
      t301 = 0.1D1*t300
      t305 = 0.8740794299481065D-3*t278*t143*t155*t163
      t306 = t139**2
      t319 = 0.1124999956683108D1*t134/t306*(-0.135956911724794D1*t288
     &-0.7491972878592054D0*t278-0.2150486235638321D0*t292
     &-0.1274341730084892D0*t295)/t142*t155*t163
      t320 = t146*t277
      t321 = 1.D0*t320
      t325 = 1.D0*t115
      t329 = 0.1333333333333333D1*t149*(t115-t321)
     &+0.1333333333333333D1*t153*(-t325+t320)
      t334 = t156*t146*t160
      t335 = 4.D0*t334
      t338 = t157/t159/t114
      t339 = 4.D0*t338
      t346 = t173**2
      t363 = 0.1923661050931536D1*(0.1321010150222857D-2*t278*t177
     &+0.1D1*t168/t346*(-0.1853395810515781D1*t288-0.128158207914907D1
     &*t278-0.8223668877838045D0*t292-0.1603914194192128D0*t295)/t176
     &-0.2747799777968419D-2*t279-0.1D1*t300)*t155*t161
      t367 = t181*t334
      t370 = 0.7694644203726145D1*t181*t338
      t384 = t193*t202
      t389 = t200/t201/t196
      s1 = -0.12407009817988D1*t4*t26-0.9305257363491D0*t5*(
     &-0.5102933333333333D-3*t212*t13-0.14825216D-3*t218*t23
     &+0.6011733333333333D-6*t225*t227)-0.3109D-1*t233*t55
     &+0.1321010150222857D-2*t237*t56
      vrhoa(i) = s1+0.1D1*t33*t241*t258*t259*t55-0.3109D-1*t33*t45*
     &(0.3688970666666667D0*t212*t48-0.15800256D0*t218*t52
     &+0.1684462933333333D-1*t225*t269)+(-t132+t166+t183+t114*(t280
     &+t301-t305-t319+0.3799574853701528D-1*t144*t329*t163
     &+0.3799574853701528D-1*t144*t155*(-t335+t339)+t363
     &+0.1923661050931536D1*t180*t329*t161+0.7694644203726145D1*t367
     &-t370)+0.3109D-1*t233-0.1321010150222857D-2*t237*t45-0.1D1*t33
     &*t241*t258*t259)*t205+t190*(-0.1125008D-1*t212*t197
     &+0.78179808D-3*t384*t212-0.42857856D-5*t389*t212)
      t399 = sigmabb/t62/t61/rhob
      t405 = t71/t59/t72/t61
      t409 = t72**2
      t412 = t71*sigmabb/t409/rhob
      t414 = 1/t77/t67
      t420 = t87*t100
      t423 = 1/t94
      t424 = t84*t423
      t427 = t96**2
      t428 = 1/t427
      t430 = t89**2
      t431 = t430**2
      t434 = 1/t61
      t445 = -0.1853395810515781D1/t431/t89*t434-0.128158207914907D1
     &*t423*t434-0.8223668877838045D0/t92*t434-0.1603914194192128D0
     &/t85*t434
      t446 = 1/t99
      t456 = 1/t106/t102
      t469 = 0.1333333333333333D1*t149*(-t325-t321)
     &+0.1333333333333333D1*t153*(t115+t320)
      s1 = -0.12407009817988D1*t59*t81-0.9305257363491D0*t60*(
     &-0.5102933333333333D-3*t399*t68-0.14825216D-3*t405*t78
     &+0.6011733333333333D-6*t412*t414)-0.3109D-1*t420*t110
     &+0.1321010150222857D-2*t424*t111
      vrhob(i) = s1+0.1D1*t88*t428*t445*t446*t110-0.3109D-1*t88*t100*
     &(0.3688970666666667D0*t399*t103-0.15800256D0*t405*t107
     &+0.1684462933333333D-1*t412*t456)+(-t132+t166+t183+t114*(t280
     &+t301-t305-t319+0.3799574853701528D-1*t144*t469*t163
     &+0.3799574853701528D-1*t144*t155*(t335+t339)+t363
     &+0.1923661050931536D1*t180*t469*t161-0.7694644203726145D1*t367
     &-t370)+0.3109D-1*t420-0.1321010150222857D-2*t424*t100-0.1D1*t88
     &*t428*t445*t446)*t205+t190*(-0.1125008D-1*t399*t197
     &+0.78179808D-3*t384*t399-0.42857856D-5*t389*t399)
      t502 = sigmaaa*t20
      t506 = t16/t222
      vsigmaaa(i) = -0.9305257363491D0*t5*(0.19136D-3*t9*t13
     &+0.5559456D-4*t502*t23-0.22544D-6*t506*t227)-0.3109D-1*t33*t45*(
     &-0.1383364D0*t9*t48+0.5925096D-1*t502*t52-0.6316736D-2*t506*t269
     &)+t190*(0.421878D-2*t9*t197-0.29317428D-3*t384*t9+0.16071696D-5
     &*t389*t9)
      vsigmaab(i) = 0.D0
      t532 = sigmabb*t75
      t536 = t71/t409
      vsigmabb(i) = -0.9305257363491D0*t60*(0.19136D-3*t64*t68
     &+0.5559456D-4*t532*t78-0.22544D-6*t536*t414)-0.3109D-1*t88*t100*
     &(-0.1383364D0*t64*t103+0.5925096D-1*t532*t107-0.6316736D-2*t536
     &*t456)+t190*(0.421878D-2*t64*t197-0.29317428D-3*t384*t64
     &+0.16071696D-5*t389*t64)
      endif ! rhoa,rhob
      else ! rho
      zk(i) = 0.0d0
      vrhoa(i) = 0.0d0
      vrhob(i) = 0.0d0
      vsigmaaa(i) = 0.0d0
      vsigmaab(i) = 0.0d0
      vsigmabb(i) = 0.0d0
      endif ! rho
      enddo
      
      else if(ideriv.eq.2) then
      
      do i=1,npt
      rhoa = dmax1(0.D0,rhoa1(i))
      rhob = dmax1(0.D0,rhob1(i))
      rho = rhoa+rhob
      if(rho.gt.tol) then
      if(rhoa.lt.tol) then
      rho = rhob
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmabb
      t2 = rhob**(1.D0/3.D0)
      t3 = t2*rhob
      t4 = rhob**2
      t5 = t2**2
      t7 = 1/t5/t4
      t8 = sigmabb*t7
      t10 = 1.D0+0.4D-2*t8
      t11 = 1/t10
      t14 = sigmabb**2
      t15 = t4**2
      t18 = 1/t2/t15/rhob
      t19 = t14*t18
      t20 = t10**2
      t21 = 1/t20
      t24 = 0.827642D0+0.19136D-3*t8*t11+0.2818D-4*t19*t21
      t27 = 1/rhob
      t28 = t27**(1.D0/3.D0)
      t30 = 1.D0+0.1274696188700087D0*t28
      t31 = rhob*t30
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t39 = 0.1112037486309468D2*t32+0.3844746237447211D1*t28
     &+0.1644733775567609D1*t35+0.2405871291288192D0*t37
      t42 = 1.D0+0.321646831778707D2/t39
      t43 = dlog(t42)
      t45 = 1.D0+0.2D0*t8
      t46 = 1/t45
      t49 = t45**2
      t50 = 1/t49
      t53 = 0.585808D0-0.1383364D0*t8*t46+0.1579184D-1*t19*t50
      t54 = t43*t53
      zk(i) = -0.9305257363491D0*t3*t24-0.3109D-1*t31*t54
      vrhoa(i) = 0.D0
      t59 = t4*rhob
      t62 = sigmabb/t5/t59
      t68 = t14/t2/t15/t4
      t71 = t14*sigmabb
      t72 = t15**2
      t75 = t71/t72/rhob
      t77 = 1/t20/t10
      t80 = -0.5102933333333333D-3*t62*t11-0.14825216D-3*t68*t21
     &+0.6011733333333333D-6*t75*t77
      t83 = t30*t43
      t86 = 1/t37
      t87 = t27*t86
      t90 = t39**2
      t91 = 1/t90
      t92 = t31*t91
      t93 = t32**2
      t94 = t93**2
      t95 = t94*t32
      t96 = 1/t95
      t97 = 1/t4
      t102 = 1/t35
      t105 = 1/t28
      t108 = -0.1853395810515781D1*t96*t97-0.128158207914907D1*t86*t97
     &-0.8223668877838045D0*t102*t97-0.1603914194192128D0*t105*t97
      t109 = 1/t42
      t110 = t108*t109
      t111 = t110*t53
      t119 = 1/t49/t45
      t122 = 0.3688970666666667D0*t62*t46-0.15800256D0*t68*t50
     &+0.1684462933333333D-1*t75*t119
      t123 = t43*t122
      vrhob(i) = -0.12407009817988D1*t2*t24-0.9305257363491D0*t3*t80
     &-0.3109D-1*t83*t53+0.1321010150222857D-2*t87*t54+0.1D1*t92*t111
     &-0.3109D-1*t31*t123
      vsigmaaa(i) = 0.D0
      vsigmaab(i) = 0.D0
      t128 = sigmabb*t18
      t131 = 1/t72
      t132 = t14*t131
      vsigmabb(i) = -0.9305257363491D0*t3*(0.19136D-3*t7*t11
     &+0.5559456D-4*t128*t21-0.22544D-6*t132*t77)-0.3109D-1*t31*t43*(
     &-0.1383364D0*t7*t46+0.5925096D-1*t128*t50-0.6316736D-2*t132*t119)
      v2rhoa2(i) = 0.D0
      v2rhoab(i) = 0.D0
      t155 = sigmabb/t5/t15
      t161 = t14/t2/t15/t59
      t164 = t72*t4
      t166 = t71/t164
      t169 = t14**2
      t173 = t169/t5/t72/t15
      t174 = t20**2
      t175 = 1/t174
      t186 = 1/t59
      t188 = 1/t37/t27
      t200 = t108**2
      t207 = 1/t15
      t233 = t90**2
      t236 = t42**2
      t251 = t49**2
      t252 = 1/t251
      s1 = -0.4135669939329333D0/t5*t24-0.24814019635976D1*t2*t80
     &-0.9305257363491D0*t3*(0.1871075555555556D-2*t155*t11
     &+0.9334872177777778D-3*t161*t21-0.8573272746666667D-5*t166*t77
     &+0.1923754666666667D-7*t173*t175)+0.2D1*t30*t91*t111-0.6218D-1
     &*t83*t122+0.8806734334819047D-3*t186*t188*t54
      v2rhob2(i) = s1-0.8497974591333914D-1*t87*t91*t111
     &+0.2642020300445714D-2*t87*t123-0.2D1*t31/t90/t39*t200*t109*t53
     &+0.1D1*t92*(-0.1544496508763151D1/t95/t27*t207
     &+0.3706791621031562D1*t96*t186-0.854388052766047D0*t188*t207
     &+0.2563164158298141D1*t86*t186-0.4111834438919023D0/t35/t27*t207
     &+0.1644733775567609D1*t102*t186-0.5346380647307093D-1/t28/t27
     &*t207+0.3207828388384256D0*t105*t186)*t109*t53
     &+0.321646831778707D2*t31/t233*t200/t236*t53+0.2D1*t92*t110*t122
     &-0.3109D-1*t31*t43*(-0.1352622577777778D1*t155*t46
     &+0.1197427982222222D1*t161*t50-0.320137728D0*t166*t119
     &+0.2695140693333333D-1*t173*t252)
      v2sigmaaa2(i) = 0.D0
      v2sigmaaaab(i) = 0.D0
      v2sigmaaabb(i) = 0.D0
      v2sigmaab2(i) = 0.D0
      v2sigmaabbb(i) = 0.D0
      t261 = sigmabb*t131
      t266 = t14/t5/t164
      v2sigmabb2(i) = -0.9305257363491D0*t3*(0.5482912D-4*t18*t21
     &-0.89563648D-6*t261*t77+0.270528D-8*t266*t175)-0.3109D-1*t31*t43
     &*(0.8691824D-1*t18*t50-0.36333856D-1*t261*t119+0.37900416D-2
     &*t266*t252)
      elseif(rhob.lt.tol) then
      rho = rhoa
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigma = sigmaaa
      t2 = rhoa**(1.D0/3.D0)
      t3 = t2*rhoa
      t4 = rhoa**2
      t5 = t2**2
      t7 = 1/t5/t4
      t8 = sigmaaa*t7
      t10 = 1.D0+0.4D-2*t8
      t11 = 1/t10
      t14 = sigmaaa**2
      t15 = t4**2
      t18 = 1/t2/t15/rhoa
      t19 = t14*t18
      t20 = t10**2
      t21 = 1/t20
      t24 = 0.827642D0+0.19136D-3*t8*t11+0.2818D-4*t19*t21
      t27 = 1/rhoa
      t28 = t27**(1.D0/3.D0)
      t30 = 1.D0+0.1274696188700087D0*t28
      t31 = rhoa*t30
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t39 = 0.1112037486309468D2*t32+0.3844746237447211D1*t28
     &+0.1644733775567609D1*t35+0.2405871291288192D0*t37
      t42 = 1.D0+0.321646831778707D2/t39
      t43 = dlog(t42)
      t45 = 1.D0+0.2D0*t8
      t46 = 1/t45
      t49 = t45**2
      t50 = 1/t49
      t53 = 0.585808D0-0.1383364D0*t8*t46+0.1579184D-1*t19*t50
      t54 = t43*t53
      zk(i) = -0.9305257363491D0*t3*t24-0.3109D-1*t31*t54
      t59 = t4*rhoa
      t62 = sigmaaa/t5/t59
      t68 = t14/t2/t15/t4
      t71 = t14*sigmaaa
      t72 = t15**2
      t75 = t71/t72/rhoa
      t77 = 1/t20/t10
      t80 = -0.5102933333333333D-3*t62*t11-0.14825216D-3*t68*t21
     &+0.6011733333333333D-6*t75*t77
      t83 = t30*t43
      t86 = 1/t37
      t87 = t27*t86
      t90 = t39**2
      t91 = 1/t90
      t92 = t31*t91
      t93 = t32**2
      t94 = t93**2
      t95 = t94*t32
      t96 = 1/t95
      t97 = 1/t4
      t102 = 1/t35
      t105 = 1/t28
      t108 = -0.1853395810515781D1*t96*t97-0.128158207914907D1*t86*t97
     &-0.8223668877838045D0*t102*t97-0.1603914194192128D0*t105*t97
      t109 = 1/t42
      t110 = t108*t109
      t111 = t110*t53
      t119 = 1/t49/t45
      t122 = 0.3688970666666667D0*t62*t46-0.15800256D0*t68*t50
     &+0.1684462933333333D-1*t75*t119
      t123 = t43*t122
      vrhoa(i) = -0.12407009817988D1*t2*t24-0.9305257363491D0*t3*t80
     &-0.3109D-1*t83*t53+0.1321010150222857D-2*t87*t54+0.1D1*t92*t111
     &-0.3109D-1*t31*t123
      vrhob(i) = 0.D0
      t128 = sigmaaa*t18
      t131 = 1/t72
      t132 = t14*t131
      vsigmaaa(i) = -0.9305257363491D0*t3*(0.19136D-3*t7*t11
     &+0.5559456D-4*t128*t21-0.22544D-6*t132*t77)-0.3109D-1*t31*t43*(
     &-0.1383364D0*t7*t46+0.5925096D-1*t128*t50-0.6316736D-2*t132*t119)
      vsigmaab(i) = 0.D0
      vsigmabb(i) = 0.D0
      t155 = sigmaaa/t5/t15
      t161 = t14/t2/t15/t59
      t164 = t72*t4
      t166 = t71/t164
      t169 = t14**2
      t173 = t169/t5/t72/t15
      t174 = t20**2
      t175 = 1/t174
      t186 = 1/t59
      t188 = 1/t37/t27
      t200 = t108**2
      t207 = 1/t15
      t233 = t90**2
      t236 = t42**2
      t251 = t49**2
      t252 = 1/t251
      s1 = -0.4135669939329333D0/t5*t24-0.24814019635976D1*t2*t80
     &-0.9305257363491D0*t3*(0.1871075555555556D-2*t155*t11
     &+0.9334872177777778D-3*t161*t21-0.8573272746666667D-5*t166*t77
     &+0.1923754666666667D-7*t173*t175)+0.2D1*t30*t91*t111-0.6218D-1
     &*t83*t122+0.8806734334819047D-3*t186*t188*t54
      v2rhoa2(i) = s1-0.8497974591333914D-1*t87*t91*t111
     &+0.2642020300445714D-2*t87*t123-0.2D1*t31/t90/t39*t200*t109*t53
     &+0.1D1*t92*(-0.1544496508763151D1/t95/t27*t207
     &+0.3706791621031562D1*t96*t186-0.854388052766047D0*t188*t207
     &+0.2563164158298141D1*t86*t186-0.4111834438919023D0/t35/t27*t207
     &+0.1644733775567609D1*t102*t186-0.5346380647307093D-1/t28/t27
     &*t207+0.3207828388384256D0*t105*t186)*t109*t53
     &+0.321646831778707D2*t31/t233*t200/t236*t53+0.2D1*t92*t110*t122
     &-0.3109D-1*t31*t43*(-0.1352622577777778D1*t155*t46
     &+0.1197427982222222D1*t161*t50-0.320137728D0*t166*t119
     &+0.2695140693333333D-1*t173*t252)
      v2rhob2(i) = 0.D0
      v2rhoab(i) = 0.D0
      t261 = sigmaaa*t131
      t266 = t14/t5/t164
      v2sigmaaa2(i) = -0.9305257363491D0*t3*(0.5482912D-4*t18*t21
     &-0.89563648D-6*t261*t77+0.270528D-8*t266*t175)-0.3109D-1*t31*t43
     &*(0.8691824D-1*t18*t50-0.36333856D-1*t261*t119+0.37900416D-2
     &*t266*t252)
      v2sigmaaaab(i) = 0.D0
      v2sigmaaabb(i) = 0.D0
      v2sigmaab2(i) = 0.D0
      v2sigmaabbb(i) = 0.D0
      v2sigmabb2(i) = 0.D0
      else ! (.not.(rhoa.lt.tol).and..not.(rhob.lt.tol))
      sigmaaa = dmax1(0.D0,sigmaaa1(i))
      sigmaab = sigmaab1(i)
      sigmabb = dmax1(0.D0,sigmabb1(i))
      sigma = sigmaaa+sigmabb+2.D0*sigmaab
      t4 = rhoa**(1.D0/3.D0)
      t5 = t4*rhoa
      t6 = rhoa**2
      t7 = t4**2
      t9 = 1/t7/t6
      t10 = sigmaaa*t9
      t12 = 1.D0+0.4D-2*t10
      t13 = 1/t12
      t16 = sigmaaa**2
      t17 = t6**2
      t20 = 1/t4/t17/rhoa
      t21 = t16*t20
      t22 = t12**2
      t23 = 1/t22
      t26 = 0.827642D0+0.19136D-3*t10*t13+0.2818D-4*t21*t23
      t29 = 1/rhoa
      t30 = t29**(1.D0/3.D0)
      t32 = 1.D0+0.1274696188700087D0*t30
      t33 = rhoa*t32
      t34 = t29**(1.D0/6.D0)
      t37 = dsqrt(t29)
      t39 = t30**2
      t41 = 0.1112037486309468D2*t34+0.3844746237447211D1*t30
     &+0.1644733775567609D1*t37+0.2405871291288192D0*t39
      t44 = 1.D0+0.321646831778707D2/t41
      t45 = dlog(t44)
      t47 = 1.D0+0.2D0*t10
      t48 = 1/t47
      t51 = t47**2
      t52 = 1/t51
      t55 = 0.585808D0-0.1383364D0*t10*t48+0.1579184D-1*t21*t52
      t56 = t45*t55
      t59 = rhob**(1.D0/3.D0)
      t60 = t59*rhob
      t61 = rhob**2
      t62 = t59**2
      t64 = 1/t62/t61
      t65 = sigmabb*t64
      t67 = 1.D0+0.4D-2*t65
      t68 = 1/t67
      t71 = sigmabb**2
      t72 = t61**2
      t75 = 1/t59/t72/rhob
      t76 = t71*t75
      t77 = t67**2
      t78 = 1/t77
      t81 = 0.827642D0+0.19136D-3*t65*t68+0.2818D-4*t76*t78
      t84 = 1/rhob
      t85 = t84**(1.D0/3.D0)
      t87 = 1.D0+0.1274696188700087D0*t85
      t88 = rhob*t87
      t89 = t84**(1.D0/6.D0)
      t92 = dsqrt(t84)
      t94 = t85**2
      t96 = 0.1112037486309468D2*t89+0.3844746237447211D1*t85
     &+0.1644733775567609D1*t92+0.2405871291288192D0*t94
      t99 = 1.D0+0.321646831778707D2/t96
      t100 = dlog(t99)
      t102 = 1.D0+0.2D0*t65
      t103 = 1/t102
      t106 = t102**2
      t107 = 1/t106
      t110 = 0.585808D0-0.1383364D0*t65*t103+0.1579184D-1*t76*t107
      t111 = t100*t110
      t114 = rhoa+rhob
      t115 = 1/t114
      t116 = t115**(1.D0/3.D0)
      t118 = 1.D0+0.1325688999052018D0*t116
      t119 = t115**(1.D0/6.D0)
      t122 = dsqrt(t115)
      t124 = t116**2
      t126 = 0.598255043577108D1*t119+0.2225569421150687D1*t116
     &+0.8004286349993634D0*t122+0.1897004325747559D0*t124
      t129 = 1.D0+0.160818243221511D2/t126
      t130 = dlog(t129)
      t132 = 0.62182D-1*t118*t130
      t134 = 1.D0+0.6901399211255825D-1*t116
      t139 = 0.8157414703487641D1*t119+0.2247591863577616D1*t116
     &+0.4300972471276643D0*t122+0.1911512595127338D0*t124
      t142 = 1.D0+0.2960857464321668D2/t139
      t143 = dlog(t142)
      t144 = t134*t143
      t146 = rhoa-1.D0*rhob
      t147 = t146*t115
      t148 = 1.D0+t147
      t149 = t148**(1.D0/3.D0)
      t152 = 1.D0-1.D0*t147
      t153 = t152**(1.D0/3.D0)
      t155 = t149*t148+t153*t152-2.D0
      t156 = t146**2
      t157 = t156**2
      t158 = t114**2
      t159 = t158**2
      t160 = 1/t159
      t161 = t157*t160
      t163 = 1.D0-1.D0*t161
      t164 = t155*t163
      t166 = 0.3799574853701528D-1*t144*t164
      t168 = 1.D0+0.1274696188700087D0*t116
      t173 = 0.1112037486309468D2*t119+0.3844746237447211D1*t116
     &+0.1644733775567609D1*t122+0.2405871291288192D0*t124
      t176 = 1.D0+0.321646831778707D2/t173
      t177 = dlog(t176)
      t180 = -0.3109D-1*t168*t177+t132
      t181 = t180*t155
      t183 = 0.1923661050931536D1*t181*t161
      t190 = t114*(-t132+t166+t183)+0.3109D-1*t33*t45+0.3109D-1*t88*t100
      t193 = 0.5D0*t10+0.5D0*t65
      t196 = 1.D0+0.3D-2*t10+0.3D-2*t65
      t197 = 1/t196
      t200 = t193**2
      t201 = t196**2
      t202 = 1/t201
      t205 = 0.999849D0+0.843756D-2*t193*t197-0.2678616D-3*t200*t202
      zk(i) = -0.9305257363491D0*t5*t26-0.3109D-1*t33*t56
     &-0.9305257363491D0*t60*t81-0.3109D-1*t88*t111+t190*t205
      t209 = t6*rhoa
      t211 = 1/t7/t209
      t212 = sigmaaa*t211
      t217 = 1/t4/t17/t6
      t218 = t16*t217
      t221 = t16*sigmaaa
      t222 = t17**2
      t224 = 1/t222/rhoa
      t225 = t221*t224
      t227 = 1/t22/t12
      t230 = -0.5102933333333333D-3*t212*t13-0.14825216D-3*t218*t23
     &+0.6011733333333333D-6*t225*t227
      t233 = t32*t45
      t236 = 1/t39
      t237 = t29*t236
      t240 = t41**2
      t241 = 1/t240
      t242 = t33*t241
      t243 = t34**2
      t244 = t243**2
      t245 = t244*t34
      t246 = 1/t245
      t247 = 1/t6
      t252 = 1/t37
      t255 = 1/t30
      t258 = -0.1853395810515781D1*t246*t247-0.128158207914907D1*t236
     &*t247-0.8223668877838045D0*t252*t247-0.1603914194192128D0*t255
     &*t247
      t259 = 1/t44
      t260 = t258*t259
      t261 = t260*t55
      t269 = 1/t51/t47
      t272 = 0.3688970666666667D0*t212*t48-0.15800256D0*t218*t52
     &+0.1684462933333333D-1*t225*t269
      t273 = t45*t272
      t276 = 1/t124
      t277 = 1/t158
      t278 = t276*t277
      t279 = t278*t130
      t280 = 0.2747799777968419D-2*t279
      t281 = t126**2
      t282 = 1/t281
      t283 = t118*t282
      t284 = t119**2
      t285 = t284**2
      t286 = t285*t119
      t287 = 1/t286
      t288 = t287*t277
      t291 = 1/t122
      t292 = t291*t277
      t294 = 1/t116
      t295 = t294*t277
      t297 = -0.99709173929518D0*t288-0.7418564737168958D0*t278
     &-0.4002143174996817D0*t292-0.1264669550498372D0*t295
      t298 = 1/t129
      t300 = t283*t297*t298
      t301 = 0.1D1*t300
      t302 = t143*t155
      t303 = t302*t163
      t304 = t278*t303
      t305 = 0.8740794299481065D-3*t304
      t306 = t139**2
      t307 = 1/t306
      t308 = t134*t307
      t313 = -0.135956911724794D1*t288-0.7491972878592054D0*t278
     &-0.2150486235638321D0*t292-0.1274341730084892D0*t295
      t314 = t308*t313
      t315 = 1/t142
      t316 = t315*t155
      t317 = t316*t163
      t318 = t314*t317
      t319 = 0.1124999956683108D1*t318
      t320 = t146*t277
      t321 = 1.D0*t320
      t322 = t115-t321
      t325 = 1.D0*t115
      t326 = -t325+t320
      t329 = 0.1333333333333333D1*t149*t322+0.1333333333333333D1*t153
     &*t326
      t331 = t144*t329*t163
      t332 = 0.3799574853701528D-1*t331
      t333 = t156*t146
      t334 = t333*t160
      t335 = 4.D0*t334
      t337 = 1/t159/t114
      t338 = t157*t337
      t339 = 4.D0*t338
      t340 = -t335+t339
      t342 = t144*t155*t340
      t343 = 0.3799574853701528D-1*t342
      t346 = t173**2
      t347 = 1/t346
      t348 = t168*t347
      t353 = -0.1853395810515781D1*t288-0.128158207914907D1*t278
     &-0.8223668877838045D0*t292-0.1603914194192128D0*t295
      t354 = 1/t176
      t360 = 0.1321010150222857D-2*t278*t177+0.1D1*t348*t353*t354
     &-0.2747799777968419D-2*t279-0.1D1*t300
      t361 = t360*t155
      t362 = t361*t161
      t363 = 0.1923661050931536D1*t362
      t364 = t180*t329
      t365 = t364*t161
      t366 = 0.1923661050931536D1*t365
      t367 = t181*t334
      t369 = t181*t338
      t370 = 0.7694644203726145D1*t369
      t377 = t241*t258*t259
      t380 = -t132+t166+t183+t114*(t280+t301-t305-t319+t332+t343+t363
     &+t366+0.7694644203726145D1*t367-t370)+0.3109D-1*t233
     &-0.1321010150222857D-2*t237*t45-0.1D1*t33*t377
      t384 = t193*t202
      t388 = 1/t201/t196
      t389 = t200*t388
      t392 = -0.1125008D-1*t212*t197+0.78179808D-3*t384*t212
     &-0.42857856D-5*t389*t212
      vrhoa(i) = -0.12407009817988D1*t4*t26-0.9305257363491D0*t5*t230
     &-0.3109D-1*t233*t55+0.1321010150222857D-2*t237*t56+0.1D1*t242
     &*t261-0.3109D-1*t33*t273+t380*t205+t190*t392
      t396 = t61*rhob
      t398 = 1/t62/t396
      t399 = sigmabb*t398
      t404 = 1/t59/t72/t61
      t405 = t71*t404
      t408 = t71*sigmabb
      t409 = t72**2
      t411 = 1/t409/rhob
      t412 = t408*t411
      t414 = 1/t77/t67
      t417 = -0.5102933333333333D-3*t399*t68-0.14825216D-3*t405*t78
     &+0.6011733333333333D-6*t412*t414
      t420 = t87*t100
      t423 = 1/t94
      t424 = t84*t423
      t427 = t96**2
      t428 = 1/t427
      t429 = t88*t428
      t430 = t89**2
      t431 = t430**2
      t432 = t431*t89
      t433 = 1/t432
      t434 = 1/t61
      t439 = 1/t92
      t442 = 1/t85
      t445 = -0.1853395810515781D1*t433*t434-0.128158207914907D1*t423
     &*t434-0.8223668877838045D0*t439*t434-0.1603914194192128D0*t442
     &*t434
      t446 = 1/t99
      t447 = t445*t446
      t448 = t447*t110
      t456 = 1/t106/t102
      t459 = 0.3688970666666667D0*t399*t103-0.15800256D0*t405*t107
     &+0.1684462933333333D-1*t412*t456
      t460 = t100*t459
      t463 = -t325-t321
      t466 = t115+t320
      t469 = 0.1333333333333333D1*t149*t463+0.1333333333333333D1*t153
     &*t466
      t471 = t144*t469*t163
      t472 = 0.3799574853701528D-1*t471
      t473 = t335+t339
      t475 = t144*t155*t473
      t476 = 0.3799574853701528D-1*t475
      t477 = t180*t469
      t478 = t477*t161
      t479 = 0.1923661050931536D1*t478
      t487 = t428*t445*t446
      t490 = -t132+t166+t183+t114*(t280+t301-t305-t319+t472+t476+t363
     &+t479-0.7694644203726145D1*t367-t370)+0.3109D-1*t420
     &-0.1321010150222857D-2*t424*t100-0.1D1*t88*t487
      t498 = -0.1125008D-1*t399*t197+0.78179808D-3*t384*t399
     &-0.42857856D-5*t389*t399
      vrhob(i) = -0.12407009817988D1*t59*t81-0.9305257363491D0*t60
     &*t417-0.3109D-1*t420*t110+0.1321010150222857D-2*t424*t111+0.1D1
     &*t429*t448-0.3109D-1*t88*t460+t490*t205+t190*t498
      t502 = sigmaaa*t20
      t505 = 1/t222
      t506 = t16*t505
      t509 = 0.19136D-3*t9*t13+0.5559456D-4*t502*t23-0.22544D-6*t506
     &*t227
      t518 = -0.1383364D0*t9*t48+0.5925096D-1*t502*t52-0.6316736D-2
     &*t506*t269
      t519 = t45*t518
      t528 = 0.421878D-2*t9*t197-0.29317428D-3*t384*t9+0.16071696D-5
     &*t389*t9
      vsigmaaa(i) = -0.9305257363491D0*t5*t509-0.3109D-1*t33*t519+t190
     &*t528
      vsigmaab(i) = 0.D0
      t532 = sigmabb*t75
      t535 = 1/t409
      t536 = t71*t535
      t539 = 0.19136D-3*t64*t68+0.5559456D-4*t532*t78-0.22544D-6*t536
     &*t414
      t548 = -0.1383364D0*t64*t103+0.5925096D-1*t532*t107-0.6316736D-2
     &*t536*t456
      t549 = t100*t548
      t558 = 0.421878D-2*t64*t197-0.29317428D-3*t384*t64+0.16071696D-5
     &*t389*t64
      vsigmabb(i) = -0.9305257363491D0*t60*t539-0.3109D-1*t88*t549
     &+t190*t558
      t563 = t297**2
      t565 = t118/t281/t126*t563*t298
      t566 = 0.2D1*t565
      t569 = 1/t286/t115*t160
      t572 = 1/t158/t114
      t573 = t287*t572
      t577 = 1/t124/t115*t160
      t579 = t276*t572
      t583 = 1/t122/t115*t160
      t585 = t291*t572
      t589 = 1/t116/t115*t160
      t591 = t294*t572
      t595 = t283*(-0.8309097827459833D0*t569+0.199418347859036D1*t573
     &-0.4945709824779306D0*t577+0.1483712947433792D1*t579
     &-0.2001071587498409D0*t583+0.8004286349993634D0*t585
     &-0.4215565168327908D-1*t589+0.2529339100996745D0*t591)*t298
      t596 = 0.1D1*t595
      t601 = 0.5827196199654043D-3*t577*t303
      t605 = t313**2
      t608 = 0.2249999913366216D1*t134/t306/t139*t605*t317
      t611 = t278*t143*t329*t163
      t613 = t577*t130
      t614 = 0.1831866518645613D-2*t613
      t615 = t579*t130
      t616 = 0.5495599555936838D-2*t615
      t618 = t278*t302*t340
      t621 = 0.1748158859896213D-2*t579*t303
      t626 = 0.5176049209143758D-1*t278*t307*t313*t315*t164
      t627 = t281**2
      t630 = t129**2
      t633 = t118/t627*t563/t630
      t634 = 0.160818243221511D2*t633
      t637 = t278*t282*t297*t298
      t638 = 0.8837926660346786D-1*t637
      t639 = t149**2
      t640 = 1/t639
      t641 = t322**2
      t644 = 2.D0*t277
      t646 = 2.D0*t146*t572
      t647 = -t644+t646
      t650 = t153**2
      t651 = 1/t650
      t652 = t326**2
      t658 = 0.4444444444444444D0*t640*t641+0.1333333333333333D1*t149
     &*t647+0.4444444444444444D0*t651*t652-0.1333333333333333D1*t153
     &*t647
      t662 = -t566+t596+0.7599149707403056D-1*t144*t329*t340-t601+t608
     &-0.1748158859896213D-2*t611+t614-t616-0.1748158859896213D-2*t618
     &+t621+t626+t634-t638+0.3799574853701528D-1*t144*t658*t163
      t663 = t156*t160
      t664 = 12.D0*t663
      t665 = t333*t337
      t666 = 32.D0*t665
      t669 = t157/t159/t158
      t670 = 20.D0*t669
      t675 = t306**2
      t679 = t142**2
      t684 = 0.3330964519106732D2*t134/t675*t605/t679*t155*t163
      t686 = t314*t316*t340
      t699 = t353**2
      t715 = t346**2
      t718 = t176**2
      t729 = 0.8806734334819047D-3*t577*t177-0.2642020300445714D-2
     &*t579*t177-0.8497974591333914D-1*t278*t347*t353*t354-0.2D1*t168
     &/t346/t173*t699*t354+0.1D1*t348*(-0.1544496508763151D1*t569
     &+0.3706791621031562D1*t573-0.854388052766047D0*t577
     &+0.2563164158298141D1*t579-0.4111834438919023D0*t583
     &+0.1644733775567609D1*t585-0.5346380647307093D-1*t589
     &+0.3207828388384256D0*t591)*t354+0.321646831778707D2*t168/t715
     &*t699/t718-0.1831866518645613D-2*t613+0.5495599555936838D-2*t615
     &+0.8837926660346786D-1*t637+0.2D1*t565-0.1D1*t595
     &-0.160818243221511D2*t633
      t732 = 0.1923661050931536D1*t729*t155*t161
      t733 = t181*t663
      t734 = 0.2308393261117844D2*t733
      t735 = t181*t665
      t737 = t364*t334
      t739 = t364*t338
      t743 = t314*t315*t329*t163
      t756 = 0.1124999956683108D1*t308*(-0.1132974264373283D1*t569
     &+0.271913823449588D1*t573-0.4994648585728036D0*t577
     &+0.1498394575718411D1*t579-0.1075243117819161D0*t583
     &+0.4300972471276643D0*t585-0.4247805766949639D-1*t589
     &+0.2548683460169784D0*t591)*t317
      t758 = t360*t329*t161
      t760 = t361*t334
      t763 = 0.1538928840745229D2*t361*t338
      t765 = 0.3847322101863073D2*t181*t669
      t769 = 0.3799574853701528D-1*t144*t155*(-t664+t666-t670)-t684
     &-0.2249999913366216D1*t686+t732+t734-0.6155715362980916D2*t735
     &+0.1538928840745229D2*t737-0.1538928840745229D2*t739
     &-0.2249999913366216D1*t743-t756+0.3847322101863073D1*t758
     &+0.1538928840745229D2*t760-t763+t765+0.1923661050931536D1*t180
     &*t658*t161
      t772 = t32*t241
      t775 = 0.2D1*t300
      t776 = t240**2
      t777 = 1/t776
      t778 = t258**2
      t780 = t44**2
      t781 = 1/t780
      t787 = 1/t17
      t790 = 1/t209
      t794 = 1/t39/t29
      t811 = -0.1544496508763151D1/t245/t29*t787+0.3706791621031562D1
     &*t246*t790-0.854388052766047D0*t794*t787+0.2563164158298141D1
     &*t236*t790-0.4111834438919023D0/t37/t29*t787
     &+0.1644733775567609D1*t252*t790-0.5346380647307093D-1/t30/t29
     &*t787+0.3207828388384256D0*t255*t790
      t816 = t790*t794
      t822 = 1/t240/t41
      t828 = 0.1748158859896213D-2*t304
      t829 = 0.2249999913366216D1*t318
      t830 = 0.3847322101863073D1*t362
      t832 = 0.5495599555936838D-2*t279
      t834 = 0.1538928840745229D2*t369
      t836 = t114*(t662+t769)-0.2D1*t772*t260+t775-0.321646831778707D2
     &*t33*t777*t778*t781-0.1D1*t33*t241*t811*t259
     &-0.8806734334819047D-3*t816*t45+0.8497974591333914D-1*t237*t377
     &+0.2D1*t33*t822*t778*t259+0.7599149707403056D-1*t342-t828-t829
     &+t830+0.7599149707403056D-1*t331+t832+0.1538928840745229D2*t367
     &-t834+0.3847322101863073D1*t365
      t871 = sigmaaa/t7/t17
      t877 = t16/t4/t17/t209
      t880 = t222*t6
      t882 = t221/t880
      t885 = t16**2
      t889 = t885/t7/t222/t17
      t890 = t22**2
      t891 = 1/t890
      t905 = t51**2
      t906 = 1/t905
      t917 = t193*t388
      t922 = t201**2
      t924 = t200/t922
      s1 = t836*t205+0.321646831778707D2*t33*t777*t778*t781*t55+0.1D1
     &*t242*t811*t259*t55-0.8497974591333914D-1*t237*t241*t261-0.2D1
     &*t33*t822*t778*t259*t55+0.2642020300445714D-2*t237*t273+0.2D1
     &*t772*t261+0.8806734334819047D-3*t816*t56
      v2rhoa2(i) = s1+0.2D1*t242*t260*t272-0.4135669939329333D0/t7*t26
     &-0.24814019635976D1*t4*t230-0.9305257363491D0*t5*
     &(0.1871075555555556D-2*t871*t13+0.9334872177777778D-3*t877*t23
     &-0.8573272746666667D-5*t882*t227+0.1923754666666667D-7*t889*t891
     &)-0.6218D-1*t233*t272-0.3109D-1*t33*t45*(-0.1352622577777778D1
     &*t871*t48+0.1197427982222222D1*t877*t52-0.320137728D0*t882*t269
     &+0.2695140693333333D-1*t889*t906)+t190*(0.4125029333333333D-1
     &*t871*t197-0.113239808D-2*t877*t202+0.2393753088D-4*t917*t877
     &-0.286659296D-2*t384*t871-0.1028588544D-6*t924*t877
     &+0.157145472D-4*t389*t871)+2.D0*t380*t392
      t940 = sigmabb/t62/t72
      t946 = t71/t59/t72/t396
      t949 = t409*t61
      t951 = t408/t949
      t954 = t71**2
      t958 = t954/t62/t409/t72
      t959 = t77**2
      t960 = 1/t959
      t968 = t87*t428
      t973 = 1/t396
      t975 = 1/t94/t84
      t976 = t973*t975
      t988 = t106**2
      t989 = 1/t988
      t997 = 1/t427/t96
      t999 = t445**2
      t1009 = t314*t316*t473
      t1011 = t463**2
      t1014 = t644+t646
      t1017 = t466**2
      t1023 = 0.4444444444444444D0*t640*t1011+0.1333333333333333D1
     &*t149*t1014+0.4444444444444444D0*t651*t1017-0.1333333333333333D1
     &*t153*t1014
      t1028 = t278*t302*t473
      t1032 = t278*t143*t469*t163
      t1037 = -0.2249999913366216D1*t1009+0.3799574853701528D-1*t144
     &*t1023*t163-t566+t596-0.1748158859896213D-2*t1028
     &-0.1748158859896213D-2*t1032-t601+t608+t614-t616+t621+t626+t634
     &+0.7599149707403056D-1*t144*t469*t473
      t1048 = t360*t469*t161
      t1050 = t477*t338
      t1052 = t477*t334
      t1056 = t314*t315*t469*t163
      t1058 = -t638-t684+0.3799574853701528D-1*t144*t155*(-t664-t666
     &-t670)+t732+t734+0.6155715362980916D2*t735-t756
     &+0.1923661050931536D1*t180*t1023*t161-0.1538928840745229D2*t760
     &-t763+t765+0.3847322101863073D1*t1048-0.1538928840745229D2*t1050
     &-0.1538928840745229D2*t1052-0.2249999913366216D1*t1056
      t1073 = 1/t72
      t1094 = -0.1544496508763151D1/t432/t84*t1073
     &+0.3706791621031562D1*t433*t973-0.854388052766047D0*t975*t1073
     &+0.2563164158298141D1*t423*t973-0.4111834438919023D0/t92/t84
     &*t1073+0.1644733775567609D1*t439*t973-0.5346380647307093D-1/t85
     &/t84*t1073+0.3207828388384256D0*t442*t973
      t1099 = t427**2
      t1100 = 1/t1099
      t1102 = t99**2
      t1103 = 1/t1102
      t1107 = t775-t828-t829+t830+t832-0.1538928840745229D2*t367-t834
     &+0.7599149707403056D-1*t471+0.7599149707403056D-1*t475
     &+0.3847322101863073D1*t478+t114*(t1037+t1058)-0.2D1*t968*t447
     &-0.8806734334819047D-3*t976*t100+0.8497974591333914D-1*t424*t487
     &+0.2D1*t88*t997*t999*t446-0.1D1*t88*t428*t1094*t446
     &-0.321646831778707D2*t88*t1100*t999*t1103
      s1 = -0.4135669939329333D0/t62*t81-0.24814019635976D1*t59*t417
     &-0.9305257363491D0*t60*(0.1871075555555556D-2*t940*t68
     &+0.9334872177777778D-3*t946*t78-0.8573272746666667D-5*t951*t414
     &+0.1923754666666667D-7*t958*t960)-0.6218D-1*t420*t459+0.2D1*t968
     &*t448+0.2642020300445714D-2*t424*t460+0.8806734334819047D-3*t976
     &*t111-0.8497974591333914D-1*t424*t428*t448
      v2rhob2(i) = s1-0.3109D-1*t88*t100*(-0.1352622577777778D1*t940
     &*t103+0.1197427982222222D1*t946*t107-0.320137728D0*t951*t456
     &+0.2695140693333333D-1*t958*t989)-0.2D1*t88*t997*t999*t446*t110
     &+t1107*t205+0.1D1*t429*t1094*t446*t110+0.2D1*t429*t447*t459
     &+0.321646831778707D2*t88*t1100*t999*t1103*t110+2.D0*t490*t498
     &+t190*(0.4125029333333333D-1*t940*t197-0.113239808D-2*t946*t202
     &+0.2393753088D-4*t917*t946-0.286659296D-2*t384*t940
     &-0.1028588544D-6*t924*t946+0.157145472D-4*t389*t940)
      t1161 = 0.4444444444444444D0*t640*t322*t463+0.2666666666666667D1
     &*t149*t146*t572+0.4444444444444444D0*t651*t326*t466
     &-0.2666666666666667D1*t153*t146*t572
      t1168 = -0.1124999956683108D1*t1009-t566+t596
     &-0.8740794299481065D-3*t1028-0.8740794299481065D-3*t1032-t601
     &+t608-0.8740794299481065D-3*t611+t614-t616-0.8740794299481065D-3
     &*t618+t621+0.3799574853701528D-1*t144*t155*(t664-t670)
     &+0.3799574853701528D-1*t144*t329*t473+0.3799574853701528D-1*t144
     &*t1161*t163+0.1923661050931536D1*t180*t1161*t161+t626
      t1182 = t634-t638-t684-0.1124999956683108D1*t686+t732
     &-0.2308393261117844D2*t733-0.7694644203726145D1*t737
     &-0.7694644203726145D1*t739-0.1124999956683108D1*t743-t756
     &+0.1923661050931536D1*t758-t763+t765+0.3799574853701528D-1*t144
     &*t469*t340+0.1923661050931536D1*t1048-0.7694644203726145D1*t1050
     &+0.7694644203726145D1*t1052-0.1124999956683108D1*t1056
      t1185 = t832+t775-t828-t829+t472+t476+t830+t479-t834+t332+t343
     &+t366+t114*(t1168+t1182)
      t1195 = t211*sigmabb*t398
      v2rhoab(i) = t1185*t205+t380*t498+t490*t392+t190*(
     &-0.113239808D-2*t212*t202*sigmabb*t398+0.2393753088D-4*t917
     &*sigmaaa*t1195-0.1028588544D-6*t924*sigmaaa*t1195)
      t1207 = sigmaaa*t217
      t1210 = t16*t224
      t1216 = t221/t7/t222/t209
      v2rhoasigmaaa(i) = -0.12407009817988D1*t4*t509-0.9305257363491D0
     &*t5*(-0.5102933333333333D-3*t211*t13-0.2944631466666667D-3*t1207
     &*t23+0.298953728D-5*t1210*t227-0.721408D-8*t1216*t891)-0.3109D-1
     &*t233*t518+0.1321010150222857D-2*t237*t519+0.1D1*t242*t260*t518
     &-0.3109D-1*t33*t45*(0.3688970666666667D0*t211*t48
     &-0.3897845333333333D0*t1207*t52+0.113734912D0*t1210*t269
     &-0.101067776D-1*t1216*t906)+t380*t528+t190*(-0.1125008D-1*t211
     &*t197+0.42464928D-3*t1207*t202-0.897657408D-5*t917*t1207
     &+0.78179808D-3*t384*t211+0.385720704D-7*t924*t1207-0.42857856D-5
     &*t389*t211)
      v2rhoasigmaab(i) = 0.D0
      t1260 = t212*t64
      v2rhoasigmabb(i) = t380*t558+t190*(0.42464928D-3*t212*t202*t64
     &-0.897657408D-5*t917*t1260+0.385720704D-7*t924*t1260)
      t1268 = t202*t9
      t1271 = t399*t9
      v2rhobsigmaaa(i) = t490*t528+t190*(0.42464928D-3*t399*t1268
     &-0.897657408D-5*t917*t1271+0.385720704D-7*t924*t1271)
      v2rhobsigmaab(i) = 0.D0
      t1282 = sigmabb*t404
      t1285 = t71*t411
      t1291 = t408/t62/t409/t396
      v2rhobsigmabb(i) = -0.12407009817988D1*t59*t539
     &-0.9305257363491D0*t60*(-0.5102933333333333D-3*t398*t68
     &-0.2944631466666667D-3*t1282*t78+0.298953728D-5*t1285*t414
     &-0.721408D-8*t1291*t960)-0.3109D-1*t420*t548
     &+0.1321010150222857D-2*t424*t549+0.1D1*t429*t447*t548-0.3109D-1
     &*t88*t100*(0.3688970666666667D0*t398*t103-0.3897845333333333D0
     &*t1282*t107+0.113734912D0*t1285*t456-0.101067776D-1*t1291*t989)
     &+t490*t558+t190*(-0.1125008D-1*t398*t197+0.42464928D-3*t1282
     &*t202-0.897657408D-5*t917*t1282+0.78179808D-3*t384*t398
     &+0.385720704D-7*t924*t1282-0.42857856D-5*t389*t398)
      t1333 = sigmaaa*t505
      t1338 = t16/t7/t880
      v2sigmaaa2(i) = -0.9305257363491D0*t5*(0.5482912D-4*t20*t23
     &-0.89563648D-6*t1333*t227+0.270528D-8*t1338*t891)-0.3109D-1*t33
     &*t45*(0.8691824D-1*t20*t52-0.36333856D-1*t1333*t269
     &+0.37900416D-2*t1338*t906)+t190*(-0.15924348D-3*t20*t202
     &+0.336621528D-5*t917*t20-0.144645264D-7*t924*t20)
      v2sigmaaaab(i) = 0.D0
      t1364 = t9*t64
      v2sigmaaabb(i) = t190*(-0.15924348D-3*t1268*t64+0.336621528D-5
     &*t917*t1364-0.144645264D-7*t924*t1364)
      v2sigmaab2(i) = 0.D0
      v2sigmaabbb(i) = 0.D0
      t1372 = sigmabb*t535
      t1377 = t71/t62/t949
      v2sigmabb2(i) = -0.9305257363491D0*t60*(0.5482912D-4*t75*t78
     &-0.89563648D-6*t1372*t414+0.270528D-8*t1377*t960)-0.3109D-1*t88
     &*t100*(0.8691824D-1*t75*t107-0.36333856D-1*t1372*t456
     &+0.37900416D-2*t1377*t989)+t190*(-0.15924348D-3*t75*t202
     &+0.336621528D-5*t917*t75-0.144645264D-7*t924*t75)
      endif ! rhoa,rhob
      else ! rho
      zk(i) = 0.0d0
      vrhoa(i) = 0.0d0
      vrhob(i) = 0.0d0
      v2rhoa2(i) = 0.0d0
      v2rhob2(i) = 0.0d0
      v2rhoab(i) = 0.0d0
      vsigmaaa(i) = 0.0d0
      vsigmaab(i) = 0.0d0
      vsigmabb(i) = 0.0d0
      v2rhoasigmaaa(i) = 0.0d0
      v2rhoasigmaab(i) = 0.0d0
      v2rhoasigmabb(i) = 0.0d0
      v2rhobsigmaaa(i) = 0.0d0
      v2rhobsigmaab(i) = 0.0d0
      v2rhobsigmabb(i) = 0.0d0
      v2sigmaaa2(i) = 0.0d0
      v2sigmaab2(i) = 0.0d0
      v2sigmabb2(i) = 0.0d0
      v2sigmaaaab(i) = 0.0d0
      v2sigmaaabb(i) = 0.0d0
      v2sigmaabbb(i) = 0.0d0
      endif ! rho
      enddo
      
      endif ! ideriv
      return
      end
      
      
      subroutine rks_xc_b97_2
     & (ideriv,npt,rhoa1,sigmaaa1,
     &  zk,vrhoa,vsigmaaa,
     &  v2rhoa2,v2rhoasigmaaa,v2sigmaaa2)
c
c     P.J. Wilson, T.J. Bradley, and D.J. Tozer
c     Hybrid exchange-correlation functional determined from
c     thermochemical data and ab initio potentials
c     J. Chem. Phys. 115 (2001) 9233-9242
c
c
c     CITATION:
c
c     Functionals were obtained from the Density Functional Repository 
c     as developed and distributed by the Quantum Chemistry Group, 
c     CCLRC Daresbury Laboratory, Daresbury, Cheshire, WA4 4AD 
c     United Kingdom. Contact Huub van Dam (h.j.j.vandam@dl.ac.uk) or 
c     Paul Sherwood for further information.
c
c     COPYRIGHT:
c
c     Users may incorporate the source code into software packages and
c     redistribute the source code provided the source code is not
c     changed in anyway and is properly cited in any documentation or
c     publication related to its use.
c
c     ACKNOWLEDGEMENT:
c
c     The source code was generated using Maple 8 through a modified
c     version of the dfauto script published in:
c
c        R. Strange, F.R. Manby, P.J. Knowles
c        Automatic code generation in density functional theory
c        Comp. Phys. Comm. 136 (2001) 310-318.
c
      implicit real*8 (a-h,o-z)
      integer ideriv,npt
      real*8 rhoa1(npt)
      real*8 sigmaaa1(npt)
      real*8 zk(npt),vrhoa(npt),vsigmaaa(npt)
      real*8 v2rhoa2(npt),v2rhoasigmaaa(npt),v2sigmaaa2(npt)
      parameter(tol=1.0d-20)
      
      if(ideriv.eq.0) then
      
      do i=1,npt
      rho = dmax1(0.D0,rhoa1(i))
      if(rho.gt.tol) then
      sigma = dmax1(0.D0,sigmaaa1(i))
      t2 = rho**(1.D0/3.D0)
      t4 = rho**2
      t5 = t2**2
      t8 = sigma/t5/t4
      t10 = 1.D0+0.6349604207872798D-2*t8
      t14 = sigma**2
      t15 = t4**2
      t19 = t14/t2/t15/rho
      t20 = t10**2
      t27 = 1/rho
      t28 = t27**(1.D0/3.D0)
      t31 = rho*(1.D0+0.1606016560364007D0*t28)
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t43 = dlog(1.D0+0.321646831778707D2/(0.1248219874679732D2*t32
     &+0.4844076716063854D1*t28+0.2326004811900819D1*t35
     &+0.3819082618690966D0*t37))
      t45 = 1.D0+0.3174802103936399D0*t8
      t49 = t45**2
      t68 = dlog(1.D0+0.160818243221511D2/(0.598255043577108D1*t32
     &+0.2225569421150687D1*t28+0.8004286349993634D0*t35
     &+0.1897004325747559D0*t37))
      t75 = 1.D0+0.9524406311809197D-2*t8
      t79 = t75**2
      zk(i) = -0.7385587663820224D0*t2*rho*(0.827642D0
     &+0.3037650653046347D-3*t8/t10+0.7100915037207505D-4*t19/t20)
     &-0.3109D-1*t31*t43*(0.585808D0-0.2195953468854936D0*t8/t45
     &+0.3979294326514371D-1*t19/t49)+(-0.62182D-1*rho*(1.D0
     &+0.1325688999052018D0*t28)*t68+0.3109D-1*t31*t43)*(0.999849D0
     &+0.133937916200448D-1*t8/t75-0.6749689365970411D-3*t19/t79)
      else ! rho
      zk(i) = 0.0d0
      endif ! rho
      enddo
      
      else if(ideriv.eq.1) then
      
      do i=1,npt
      rho = dmax1(0.D0,rhoa1(i))
      if(rho.gt.tol) then
      sigma = dmax1(0.D0,sigmaaa1(i))
      t2 = rho**(1.D0/3.D0)
      t3 = t2*rho
      t4 = rho**2
      t5 = t2**2
      t7 = 1/t5/t4
      t8 = sigma*t7
      t10 = 1.D0+0.6349604207872798D-2*t8
      t11 = 1/t10
      t14 = sigma**2
      t15 = t4**2
      t18 = 1/t2/t15/rho
      t19 = t14*t18
      t20 = t10**2
      t21 = 1/t20
      t24 = 0.827642D0+0.3037650653046347D-3*t8*t11
     &+0.7100915037207505D-4*t19*t21
      t27 = 1/rho
      t28 = t27**(1.D0/3.D0)
      t30 = 1.D0+0.1606016560364007D0*t28
      t31 = rho*t30
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t39 = 0.1248219874679732D2*t32+0.4844076716063854D1*t28
     &+0.2326004811900819D1*t35+0.3819082618690966D0*t37
      t42 = 1.D0+0.321646831778707D2/t39
      t43 = dlog(t42)
      t45 = 1.D0+0.3174802103936399D0*t8
      t46 = 1/t45
      t49 = t45**2
      t50 = 1/t49
      t53 = 0.585808D0-0.2195953468854936D0*t8*t46
     &+0.3979294326514371D-1*t19*t50
      t54 = t43*t53
      t58 = 1.D0+0.1325688999052018D0*t28
      t64 = 0.598255043577108D1*t32+0.2225569421150687D1*t28
     &+0.8004286349993634D0*t35+0.1897004325747559D0*t37
      t67 = 1.D0+0.160818243221511D2/t64
      t68 = dlog(t67)
      t73 = -0.62182D-1*rho*t58*t68+0.3109D-1*t31*t43
      t75 = 1.D0+0.9524406311809197D-2*t8
      t76 = 1/t75
      t79 = t75**2
      t80 = 1/t79
      t83 = 0.999849D0+0.133937916200448D-1*t8*t76
     &-0.6749689365970411D-3*t19*t80
      zk(i) = -0.7385587663820224D0*t3*t24-0.3109D-1*t31*t54+t73*t83
      t90 = sigma/t5/t4/rho
      t96 = t14/t2/t15/t4
      t100 = t15**2
      t103 = t14*sigma/t100/rho
      t105 = 1/t20/t10
      t111 = t30*t43
      t114 = 1/t37
      t115 = t27*t114
      t118 = t39**2
      t119 = 1/t118
      t121 = t32**2
      t122 = t121**2
      t125 = 1/t4
      t126 = 1/t122/t32*t125
      t128 = t114*t125
      t131 = 1/t35*t125
      t134 = 1/t28*t125
      t136 = -0.4160732915599108D1*t126-0.3229384477375903D1*t128
     &-0.2326004811900819D1*t131-0.5092110158254621D0*t134
      t137 = 1/t42
      t147 = 1/t49/t45
      t158 = t64**2
      t186 = 1/t79/t75
      s1 = -0.9847450218426965D0*t2*t24-0.3692793831910112D0*t3*(
     &-0.1620080348291385D-2*t90*t11-0.7471440683055309D-3*t96*t21
     &+0.4809386666666667D-5*t103*t105)-0.3109D-1*t111*t53
     &+0.1664368495390566D-2*t115*t54
      vrhoa(i) = s1+0.5D0*t31*t119*t136*t137*t53-0.15545D-1*t31*t43*
     &(0.1171175183389299D1*t90*t46-0.7962830051251108D0*t96*t50
     &+0.1347570346666667D0*t103*t147)+(-0.62182D-1*t58*t68+rho*
     &(0.2747799777968419D-2*t128*t68+0.1D1*t58/t158*(
     &-0.99709173929518D0*t126-0.7418564737168958D0*t128
     &-0.4002143174996817D0*t131-0.1264669550498372D0*t134)/t67)
     &+0.3109D-1*t111-0.1664368495390566D-2*t115*t43-0.5D0*t31*t119
     &*t136*t137)*t83+t73*(-0.357167776534528D-1*t90*t76
     &+0.3940015431037584D-2*t96*t80-0.342862848D-4*t103*t186)
      t193 = sigma*t18
      t197 = t14/t100
      vsigmaaa(i) = -0.7385587663820224D0*t3*(0.1215060261218539D-2*t7
     &*t11+0.5603580512291482D-3*t193*t21-0.360704D-5*t197*t105)
     &-0.3109D-1*t31*t43*(-0.8783813875419745D0*t7*t46
     &+0.5972122538438331D0*t193*t50-0.101067776D0*t197*t147)+2.D0*t73
     &*(0.267875832400896D-1*t7*t76-0.2955011573278188D-2*t193*t80
     &+0.257147136D-4*t197*t186)
      else ! rho
      zk(i) = 0.0d0
      vrhoa(i) = 0.0d0
      vsigmaaa(i) = 0.0d0
      endif ! rho
      enddo
      
      else if(ideriv.eq.2) then
      
      do i=1,npt
      rho = dmax1(0.D0,rhoa1(i))
      if(rho.gt.tol) then
      sigma = dmax1(0.D0,sigmaaa1(i))
      t2 = rho**(1.D0/3.D0)
      t3 = t2*rho
      t4 = rho**2
      t5 = t2**2
      t7 = 1/t5/t4
      t8 = sigma*t7
      t10 = 1.D0+0.6349604207872798D-2*t8
      t11 = 1/t10
      t14 = sigma**2
      t15 = t4**2
      t18 = 1/t2/t15/rho
      t19 = t14*t18
      t20 = t10**2
      t21 = 1/t20
      t24 = 0.827642D0+0.3037650653046347D-3*t8*t11
     &+0.7100915037207505D-4*t19*t21
      t27 = 1/rho
      t28 = t27**(1.D0/3.D0)
      t30 = 1.D0+0.1606016560364007D0*t28
      t31 = rho*t30
      t32 = t27**(1.D0/6.D0)
      t35 = dsqrt(t27)
      t37 = t28**2
      t39 = 0.1248219874679732D2*t32+0.4844076716063854D1*t28
     &+0.2326004811900819D1*t35+0.3819082618690966D0*t37
      t42 = 1.D0+0.321646831778707D2/t39
      t43 = dlog(t42)
      t45 = 1.D0+0.3174802103936399D0*t8
      t46 = 1/t45
      t49 = t45**2
      t50 = 1/t49
      t53 = 0.585808D0-0.2195953468854936D0*t8*t46
     &+0.3979294326514371D-1*t19*t50
      t54 = t43*t53
      t58 = 1.D0+0.1325688999052018D0*t28
      t64 = 0.598255043577108D1*t32+0.2225569421150687D1*t28
     &+0.8004286349993634D0*t35+0.1897004325747559D0*t37
      t67 = 1.D0+0.160818243221511D2/t64
      t68 = dlog(t67)
      t73 = -0.62182D-1*rho*t58*t68+0.3109D-1*t31*t43
      t75 = 1.D0+0.9524406311809197D-2*t8
      t76 = 1/t75
      t79 = t75**2
      t80 = 1/t79
      t83 = 0.999849D0+0.133937916200448D-1*t8*t76
     &-0.6749689365970411D-3*t19*t80
      zk(i) = -0.7385587663820224D0*t3*t24-0.3109D-1*t31*t54+t73*t83
      t87 = t4*rho
      t89 = 1/t5/t87
      t90 = sigma*t89
      t95 = 1/t2/t15/t4
      t96 = t14*t95
      t99 = t14*sigma
      t100 = t15**2
      t102 = 1/t100/rho
      t103 = t99*t102
      t105 = 1/t20/t10
      t108 = -0.1620080348291385D-2*t90*t11-0.7471440683055309D-3*t96
     &*t21+0.4809386666666667D-5*t103*t105
      t111 = t30*t43
      t114 = 1/t37
      t115 = t27*t114
      t118 = t39**2
      t119 = 1/t118
      t120 = t31*t119
      t121 = t32**2
      t122 = t121**2
      t123 = t122*t32
      t124 = 1/t123
      t125 = 1/t4
      t126 = t124*t125
      t128 = t114*t125
      t130 = 1/t35
      t131 = t130*t125
      t133 = 1/t28
      t134 = t133*t125
      t136 = -0.4160732915599108D1*t126-0.3229384477375903D1*t128
     &-0.2326004811900819D1*t131-0.5092110158254621D0*t134
      t137 = 1/t42
      t138 = t136*t137
      t139 = t138*t53
      t147 = 1/t49/t45
      t150 = 0.1171175183389299D1*t90*t46-0.7962830051251108D0*t96*t50
     &+0.1347570346666667D0*t103*t147
      t151 = t43*t150
      t156 = t128*t68
      t158 = t64**2
      t159 = 1/t158
      t160 = t58*t159
      t165 = -0.99709173929518D0*t126-0.7418564737168958D0*t128
     &-0.4002143174996817D0*t131-0.1264669550498372D0*t134
      t166 = 1/t67
      t168 = t160*t165*t166
      t176 = t119*t136*t137
      t179 = -0.62182D-1*t58*t68+rho*(0.2747799777968419D-2*t156+0.1D1
     &*t168)+0.3109D-1*t111-0.1664368495390566D-2*t115*t43-0.5D0*t31
     &*t176
      t182 = 0.357167776534528D-1*t90*t76
      t183 = t96*t80
      t186 = 1/t79/t75
      t188 = 0.342862848D-4*t103*t186
      t189 = -t182+0.3940015431037584D-2*t183-t188
      vrhoa(i) = -0.9847450218426965D0*t2*t24-0.3692793831910112D0*t3
     &*t108-0.3109D-1*t111*t53+0.1664368495390566D-2*t115*t54+0.5D0
     &*t120*t139-0.15545D-1*t31*t151+t179*t83+t73*t189
      t193 = sigma*t18
      t196 = 1/t100
      t197 = t14*t196
      t200 = 0.1215060261218539D-2*t7*t11+0.5603580512291482D-3*t193
     &*t21-0.360704D-5*t197*t105
      t209 = -0.8783813875419745D0*t7*t46+0.5972122538438331D0*t193
     &*t50-0.101067776D0*t197*t147
      t210 = t43*t209
      t219 = 0.267875832400896D-1*t7*t76-0.2955011573278188D-2*t193
     &*t80+0.257147136D-4*t197*t186
      vsigmaaa(i) = -0.7385587663820224D0*t3*t200-0.3109D-1*t31*t210
     &+2.D0*t73*t219
      t223 = 1/t118/t39
      t225 = t136**2
      t230 = 1/t87
      t232 = 1/t37/t27
      t233 = t230*t232
      t239 = t30*t119
      t248 = sigma/t5/t15
      t254 = t14/t2/t15/t87
      t257 = t100*t4
      t259 = t99/t257
      t262 = t14**2
      t266 = t262/t5/t100/t15
      t267 = t20**2
      t268 = 1/t267
      t285 = t49**2
      t286 = 1/t285
      t293 = t118**2
      t294 = 1/t293
      t296 = t42**2
      t297 = 1/t296
      t302 = 0.5495599555936838D-2*t156
      t303 = 0.2D1*t168
      t306 = 1/t15
      t307 = 1/t123/t27*t306
      t309 = t124*t230
      t311 = t232*t306
      t313 = t114*t230
      t317 = 1/t35/t27*t306
      t319 = t130*t230
      t323 = 1/t28/t27*t306
      t325 = t133*t230
      t330 = 0.1D1*t160*(-0.8309097827459833D0*t307
     &+0.199418347859036D1*t309-0.4945709824779306D0*t311
     &+0.1483712947433792D1*t313-0.2001071587498409D0*t317
     &+0.8004286349993634D0*t319-0.4215565168327908D-1*t323
     &+0.2529339100996745D0*t325)*t166
      t334 = t165**2
      t337 = 0.2D1*t58/t158/t64*t334*t166
      t338 = t158**2
      t341 = t67**2
      t345 = 0.160818243221511D2*t58/t338*t334/t341
      t347 = 0.1831866518645613D-2*t311*t68
      t349 = 0.5495599555936838D-2*t313*t68
      t360 = dlog(1.D0+0.2960857464321668D2/(0.8157414703487641D1*t32
     &+0.2247591863577616D1*t28+0.4300972471276643D0*t35
     &+0.1911512595127338D0*t37))
      t362 = (1.D0+0.6901399211255825D-1*t28)*t360*t125
      t367 = 0.8837926660346786D-1*t128*t159*t165*t166
      t386 = -0.6934554859331846D1*t307+0.1664293166239643D2*t309
     &-0.4305845969834537D1*t311+0.1291753790950361D2*t313
     &-0.2326004811900819D1*t317+0.9304019247603276D1*t319
     &-0.3394740105503081D0*t323+0.2036844063301848D1*t325
      t410 = t254*t80
      t412 = t259*t186
      t414 = t79**2
      t415 = 1/t414
      t417 = 0.2612452058860862D-5*t266*t415
      s1 = -0.1D1*t31*t223*t225*t137*t53+0.2219157993854088D-2*t233
     &*t54-0.1070677706909338D0*t115*t119*t139+0.2D1*t239*t139
     &+0.3328736990781132D-2*t115*t151-0.6218D-1*t111*t150
     &-0.3692793831910112D0*t3*(0.1188058922080349D-1*t248*t11
     &+0.9408961563888175D-2*t254*t21-0.1371723639466667D-3*t259*t105
     &+0.4886032290552639D-6*t266*t268)-0.6564966812284644D0/t5*t24
     &-0.1969490043685393D1*t2*t108
      s2 = s1-0.15545D-1*t31*t43*(-0.8588618011521529D1*t248*t46
     &+0.1206931776427937D2*t254*t50-0.5122203648D1*t259*t147
     &+0.6845230674879417D0*t266*t286)+0.1608234158893535D2*t31*t294
     &*t225*t297*t53+(t302+t303+rho*(t330-t337+t345+t347-t349
     &+0.3377399869956914D-1*t362-t367)-0.2219157993854088D-2*t233*t43
     &+0.1070677706909338D0*t115*t176+0.1D1*t31*t223*t225*t137-0.5D0
     &*t31*t119*t386*t137-0.2D1*t239*t138-0.1608234158893535D2*t31
     &*t294*t225*t297)*t83+0.1D1*t120*t138*t150
      v2rhoa2(i) = s2+0.5D0*t120*t386*t137*t53+3.D0*t179*t189+t73*
     &(0.2619230361253206D0*t248*t76-0.4030730391709593D-1*t410
     &+0.63443324928D-3*t412-t417)+(t302+t303+rho*(t330-t337+t345+t347
     &-t349-0.3377399869956914D-1*t362-t367))*t83+t179*(-t182
     &+0.3940015431037584D-2*t183-t188)+t73*(-0.1141385742282031D-1
     &*t410+0.38300049408D-3*t412-t417)
      t436 = sigma*t95
      t439 = t14*t102
      t445 = t99/t5/t100/t87
      t474 = t436*t80
      t476 = t439*t186
      t479 = 0.1959339044145646D-5*t445*t415
      v2rhoasigmaaa(i) = -0.9847450218426965D0*t2*t200
     &-0.3692793831910112D0*t3*(-0.6480321393165539D-2*t89*t11
     &-0.5936005070457835D-2*t436*t21+0.9566519296D-4*t439*t105
     &-0.366452421791448D-6*t445*t268)-0.3109D-1*t111*t209
     &+0.1664368495390566D-2*t115*t210+0.5D0*t120*t138*t209-0.15545D-1
     &*t31*t43*(0.4684700733557197D1*t89*t46-0.7857563815521864D1*t436
     &*t50+0.3639517184D1*t439*t147-0.5133923006159563D0*t445*t286)
     &+2.D0*t179*t219+t73*(-0.1428671106138112D0*t89*t76
     &+0.2432045479126557D-1*t474-0.42439550976D-3*t476+t479)+t73*
     &(0.8560393067115231D-2*t474-0.28725037056D-3*t476+t479)
      t488 = sigma*t196
      t493 = t14/t5/t257
      v2sigmaaa2(i) = -0.7385587663820224D0*t3*(0.2210571597926784D-2
     &*t18*t21-0.5732073472D-4*t488*t105+0.274839316343586D-6*t493
     &*t268)-0.3109D-1*t31*t43*(0.3504323846266066D1*t18*t50
     &-0.2325366784D1*t488*t147+0.3850442254619672D0*t493*t286)+4.D0
     &*t73*(-0.6420294800336424D-2*t18*t80+0.21543777792D-3*t488*t186
     &-0.1469504283109235D-5*t493*t415)
      else ! rho
      zk(i) = 0.0d0
      vrhoa(i) = 0.0d0
      v2rhoa2(i) = 0.0d0
      vsigmaaa(i) = 0.0d0
      v2rhoasigmaaa(i) = 0.0d0
      v2sigmaaa2(i) = 0.0d0
      endif ! rho
      enddo
      
      endif ! ideriv
      return
      end

c:XC_B97_2subrend
